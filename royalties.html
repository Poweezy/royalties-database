<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mining Royalties Manager</title>
  <link rel="stylesheet" href="royalties.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <!-- Loading Screen -->
  <div class="loading-screen" id="loading-screen">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <p>Loading your workspace...</p>
    </div>
  </div>

  <!-- Login Section -->
  <section class="login-section" id="login-section">
    <div class="login-container">
      <div class="login-header">
        <div class="login-logo" aria-label="Mining Royalties Manager Logo">MR</div>
        <h2>Mining Royalties Manager</h2>
        <p>Secure access to your royalty management system</p>
      </div>
      <form class="login-form">
        <div class="input-group">
          <i class="fas fa-user"></i>
          <input type="text" id="username" placeholder="Username" aria-describedby="username-error">
          <div class="validation-error" id="username-error">Username is required</div>
        </div>
        <div class="input-group">
          <i class="fas fa-lock"></i>
          <input type="password" id="password" placeholder="Password" aria-describedby="password-error">
          <button type="button" class="password-toggle" aria-label="Toggle password visibility">
            <i class="fas fa-eye"></i>
          </button>
          <div class="validation-error" id="password-error">Password is required</div>
        </div>
        <button type="submit" class="btn btn-primary btn-large">Sign In</button>
      </form>
      <div class="login-footer">
        <p>Please contact your administrator for credentials.</p>
      </div>
    </div>
  </section>

  <!-- Main App -->
  <div class="app-container" id="app-container" style="display: none;">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo" aria-label="Mining Royalties Manager Logo">MR</div>
        <h2>Royalties Manager</h2>
      </div>
      <nav>
        <ul>
          <li><a href="#dashboard"><i class="fas fa-home"></i> Dashboard</a></li>
          <li><a href="#user-management"><i class="fas fa-users"></i> User Management</a></li>
          <li><a href="#royalty-records"><i class="fas fa-file-invoice"></i> Royalty Records</a></li>
          <li><a href="#contract-management"><i class="fas fa-file-contract"></i> Contract Management</a></li>
          <li><a href="#audit-dashboard"><i class="fas fa-shield-alt"></i> Audit Dashboard</a></li>
          <li><a href="#reporting-analytics"><i class="fas fa-chart-bar"></i> Reporting & Analytics</a></li>
          <li><a href="#communication"><i class="fas fa-envelope"></i> Communication</a></li>
          <li><a href="#notifications"><i class="fas fa-bell"></i> Notifications <span>3</span></a></li>
          <li><a href="#compliance"><i class="fas fa-check-circle"></i> Compliance & Regulatory</a></li>
          <li><a href="#regulatory-management"><i class="fas fa-gavel"></i> Regulatory Management</a></li>
          <li><a href="#profile"><i class="fas fa-user"></i> My Profile</a></li>
          <li><a href="#logout"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
        </ul>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Dashboard -->
      <section id="dashboard">
        <div class="page-header">
          <div class="page-title">
            <h1>Dashboard</h1>
            <p>Welcome back, <span id="user-name">System Administrator</span> | Last login: <span id="last-login-time">Today, 09:15 AM</span></p>
          </div>
          <div class="page-actions">
            <button class="btn btn-info" id="refresh-dashboard" title="Refresh dashboard data">
              <i class="fas fa-sync-alt"></i> Refresh
            </button>
            <button class="btn btn-primary" id="admin-panel-btn" title="Access Admin Panel">
              <i class="fas fa-cog"></i> Admin Panel
            </button>
            <button class="btn btn-secondary" id="notifications-btn" title="View Notifications">
              <i class="fas fa-bell"></i> <span id="notifications-count">3</span>
            </button>
          </div>
        </div>

        <!-- Key Performance Indicators -->
        <div class="charts-grid">
          <div class="metric-card card">
            <div class="card-header">
              <h3><i class="fas fa-coins"></i> Total Royalties (YTD)</h3>
              <select class="metric-period" id="royalties-period">
                <option value="2024">2024</option>
                <option value="2023">2023</option>
                <option value="all">All Time</option>
              </select>
            </div>
            <div class="card-body">
              <p id="total-royalties">E 0.00</p>
              <small class="trend-indicator" id="royalties-trend">
                <i class="fas fa-arrow-up trend-positive"></i> +0% from last year
              </small>
              <div class="mini-progress">
                <div class="progress-bar" id="royalties-progress" style="width: 0%;"></div>
              </div>
            </div>
          </div>

          <div class="metric-card card">
            <div class="card-header">
              <h3><i class="fas fa-industry"></i> Active Entities</h3>
              <select class="metric-period" id="entities-period">
                <option value="current">This Quarter</option>
                <option value="last">Last Quarter</option>
                <option value="ytd">YTD</option>
              </select>
            </div>
            <div class="card-body">
              <p id="active-entities">6</p>
              <small class="trend-indicator" id="entities-trend">
                <i class="fas fa-arrow-up trend-positive"></i> +2 new entities
              </small>
              <div class="entities-breakdown">
                <small>
                  <span class="entity-type">Mines: <span id="mines-count">4</span></span> | 
                  <span class="entity-type">Quarries: <span id="quarries-count">2</span></span>
                </small>
              </div>
            </div>
          </div>

          <div class="metric-card card">
            <div class="card-header">
              <h3><i class="fas fa-check-circle"></i> Compliance Rate</h3>
              <button class="btn btn-sm btn-secondary" id="compliance-details" title="View compliance details">
                <i class="fas fa-info-circle"></i>
              </button>
            </div>
            <div class="card-body">
              <p id="compliance-rate">0%</p>
              <div class="collection-progress">
                <div class="progress-bar" id="compliance-progress" style="width: 0%;"></div>
              </div>
              <small class="compliance-breakdown">
                <span>Paid: <span id="paid-count">0</span></span> | 
                <span>Pending: <span id="pending-count">0</span></span> | 
                <span>Overdue: <span id="overdue-count">0</span></span>
              </small>
            </div>
          </div>

          <div class="metric-card card">
            <div class="card-header">
              <h3><i class="fas fa-clock"></i> Pending Approvals</h3>
              <button class="btn btn-sm btn-warning" id="view-pending" title="View pending items">
                <i class="fas fa-eye"></i>
              </button>
            </div>
            <div class="card-body">
              <p id="pending-approvals">3</p>
              <small id="pending-urgency">2 urgent items requiring attention</small>
              <div class="urgency-indicator">
                <span class="urgent-badge" id="urgent-items" style="display: inline-flex;">
                  <i class="fas fa-exclamation-triangle"></i> <span id="urgent-count">2</span> Urgent
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Analytics Charts Section -->
        <div class="charts-grid">
          <div class="analytics-chart card">
            <div class="chart-header">
              <h5><i class="fas fa-chart-line"></i> Revenue Trends</h5>
              <div class="chart-controls">
                <button class="chart-btn active" data-chart-type="line" data-chart-id="revenue-trends-chart">
                  <i class="fas fa-chart-line"></i> Line
                </button>
                <button class="chart-btn" data-chart-type="bar" data-chart-id="revenue-trends-chart">
                  <i class="fas fa-chart-bar"></i> Bar
                </button>
                <button class="chart-btn" data-chart-type="area" data-chart-id="revenue-trends-chart">
                  <i class="fas fa-chart-area"></i> Area
                </button>
              </div>
            </div>
            <div class="chart-container">
              <canvas id="revenue-trends-chart" aria-label="Revenue trends chart showing monthly royalty collections"></canvas>
            </div>
            <div class="chart-summary">
              <small>
                <i class="fas fa-info-circle"></i> 
                Average monthly collection: <strong>E <span id="avg-monthly">0</span></strong> | 
                Peak month: <strong><span id="peak-month">-</span></strong>
              </small>
            </div>
          </div>

          <div class="analytics-chart card">
            <div class="chart-header">
              <h5><i class="fas fa-chart-pie"></i> Production by Entity</h5>
              <div class="chart-controls">
                <button class="chart-btn active" data-chart-type="pie" data-chart-id="production-by-entity-chart">
                  <i class="fas fa-chart-pie"></i> Pie
                </button>
                <button class="chart-btn" data-chart-type="doughnut" data-chart-id="production-by-entity-chart">
                  <i class="fas fa-circle-notch"></i> Doughnut
                </button>
              </div>
            </div>
            <div class="chart-container">
              <canvas id="production-by-entity-chart" aria-label="Production volume breakdown by mining entity"></canvas>
            </div>
            <div class="chart-summary">
              <small>
                <i class="fas fa-info-circle"></i> 
                Total production: <strong><span id="total-production">0</span> m³</strong> | 
                Top producer: <strong><span id="top-producer">-</span></strong>
              </small>
            </div>
          </div>
        </div>

        <!-- Recent Activity & Quick Actions -->
        <div class="charts-grid">
          <div class="card">
            <div class="card-header">
              <h3><i class="fas fa-history"></i> Recent Activity</h3>
              <button class="btn btn-sm btn-secondary" id="view-all-activity">
                <i class="fas fa-external-link-alt"></i> View All
              </button>
            </div>
            <div class="card-body">
              <div class="activity-list" id="recent-activity">
                <div class="activity-item">
                  <div class="activity-icon">
                    <i class="fas fa-plus-circle text-success"></i>
                  </div>
                  <div class="activity-content">
                    <p><strong>New royalty record</strong> added for Kwalini Quarry</p>
                    <small>2 hours ago</small>
                  </div>
                </div>
                <div class="activity-item">
                  <div class="activity-icon">
                    <i class="fas fa-user-plus text-info"></i>
                  </div>
                  <div class="activity-content">
                    <p><strong>New user</strong> finance.manager created</p>
                    <small>5 hours ago</small>
                  </div>
                </div>
                <div class="activity-item">
                  <div class="activity-icon">
                    <i class="fas fa-file-alt text-warning"></i>
                  </div>
                  <div class="activity-content">
                    <p><strong>Compliance report</strong> submitted to ERA</p>
                    <small>1 day ago</small>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <h3><i class="fas fa-bolt"></i> Quick Actions</h3>
            </div>
            <div class="card-body">
              <div class="quick-actions-grid">
                <button class="btn btn-success quick-action-btn" id="add-royalty-record">
                  <i class="fas fa-plus"></i>
                  <span>Add Royalty Record</span>
                </button>
                <button class="btn btn-info quick-action-btn" id="generate-report">
                  <i class="fas fa-file-pdf"></i>
                  <span>Generate Report</span>
                </button>
                <button class="btn btn-warning quick-action-btn" id="view-overdue">
                  <i class="fas fa-exclamation-triangle"></i>
                  <span>View Overdue</span>
                </button>
                <button class="btn btn-primary quick-action-btn" id="manage-users">
                  <i class="fas fa-users-cog"></i>
                  <span>Manage Users</span>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- System Status & Alerts -->
        <div class="charts-grid">
          <div class="card">
            <div class="card-header">
              <h3><i class="fas fa-bell"></i> System Alerts</h3>
              <span class="alert-count" id="alert-count-badge">1</span>
            </div>
            <div class="card-body">
              <div class="alerts-container" id="system-alerts">
                <div class="alert-item info">
                  <i class="fas fa-info-circle"></i>
                  <div class="alert-content">
                    <p>System running normally</p>
                    <small>All services operational</small>
                  </div>
                </div>
                 <div class="alert-item warning">
                  <i class="fas fa-exclamation-triangle"></i>
                  <div class="alert-content">
                    <p>Database backup pending</p>
                    <small>Last backup 2 days ago</small>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <h3><i class="fas fa-server"></i> System Status</h3>
              <span class="status-indicator online" id="system-status">
                <i class="fas fa-circle"></i> Online
              </span>
            </div>
            <div class="card-body">
              <div class="system-metrics">
                <div class="metric-row">
                  <span class="metric-label">Database:</span>
                  <span class="metric-value status-good" id="db-status">
                    <i class="fas fa-circle"></i> Connected
                  </span>
                </div>
                <div class="metric-row">
                  <span class="metric-label">Last Backup:</span>
                  <span class="metric-value" id="last-backup">Today, 03:00 AM</span>
                </div>
                <div class="metric-row">
                  <span class="metric-label">Active Sessions:</span>
                  <span class="metric-value" id="active-sessions">3 users</span>
                </div>
                <div class="metric-row">
                  <span class="metric-label">Uptime:</span>
                  <span class="metric-value" id="system-uptime">7 days, 14 hours</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- User Management -->
      <section id="user-management">
        <div class="page-header">
          <div class="page-title">
            <h1>👥 User Management</h1>
            <p>Comprehensive user administration with role-based access control, security monitoring, and audit trails</p>
          </div>
          <div class="page-actions">
            <button class="btn btn-info" id="view-audit-btn" title="View detailed audit logs">
              <i class="fas fa-shield-alt"></i> View Audit Log
            </button>
            <button class="btn btn-primary" id="export-report-btn" title="Export user management report">
              <i class="fas fa-file-export"></i> Export Report
            </button>
            <button class="btn btn-success" id="add-user-btn" title="Add new user account">
              <i class="fas fa-user-plus"></i> Add User
            </button>
          </div>
        </div>
        
        <!-- User Management Metrics Dashboard -->
        <div class="charts-grid">
          <div class="metric-card card">
            <div class="card-header">
              <h3><i class="fas fa-users"></i> Active Users</h3>
              <select class="metric-period">
                <option>Current</option>
                <option>Last 30 days</option>
                <option>All time</option>
              </select>
            </div>
            <div class="card-body">
              <p id="active-users-count">3</p>
              <small><i class="fas fa-circle text-success"></i> Currently active and logged in</small>
            </div>
          </div>
          <div class="metric-card card">
            <div class="card-header">
              <h3><i class="fas fa-exclamation-triangle"></i> Failed Logins</h3>
              <select class="metric-period">
                <option>Last 24 hours</option>
                <option>Last 7 days</option>
                <option>Last 30 days</option>
              </select>
            </div>
            <div class="card-body">
              <p id="failed-logins-count">0</p>
              <small><i class="fas fa-shield-alt text-success"></i> Security status: Normal</small>
            </div>
          </div>
          <div class="metric-card card">
            <div class="card-header">
              <h3><i class="fas fa-bell"></i> Security Alerts</h3>
            </div>
            <div class="card-body">
              <p id="security-alerts-count">None</p>
              <small><i class="fas fa-check-circle text-success"></i> All systems secure</small>
            </div>
          </div>
          <div class="metric-card card">
            <div class="card-header">
              <h3><i class="fas fa-key"></i> Password Compliance</h3>
            </div>
            <div class="card-body">
              <p id="password-compliance-rate">100%</p>
              <small><i class="fas fa-certificate text-success"></i> Meeting security standards</small>
              <div class="mini-progress">
                <div class="progress-bar" style="width: 100%; background: var(--success-color);"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Add New User Form -->
        <div class="user-form-container" id="add-user-form-container" style="display: none;">
          <div class="section-header">
            <h4><i class="fas fa-user-plus"></i> Add New User Account</h4>
            <div class="table-actions">
              <button class="btn btn-secondary btn-sm" id="close-add-user-form" title="Close form">
                <i class="fas fa-times"></i> Close
              </button>
            </div>
          </div>
          
          <form id="add-user-form" novalidate>
            <div class="grid-4">
              <!-- Username Field -->
              <div class="form-group">
                <label for="new-username">
                  <i class="fas fa-user"></i> Username *
                </label>
                <input 
                  type="text" 
                  id="new-username" 
                  name="username" 
                  placeholder="Enter unique username" 
                  required 
                  aria-describedby="new-username-error new-username-success"
                  autocomplete="off"
                  minlength="3"
                  maxlength="50"
                  pattern="^[a-zA-Z0-9._-]+$"
                >
                <div class="validation-success" id="new-username-success" style="display: none;">
                  <i class="fas fa-check-circle"></i> Username is available
                </div>
                <div class="validation-error" id="new-username-error" style="display: none;">
                  <i class="fas fa-exclamation-circle"></i> Username is required and must be unique
                </div>
                <small class="form-help">3-50 characters, letters, numbers, dots, dashes, underscores only</small>
              </div>
              
              <!-- Email Field -->
              <div class="form-group">
                <label for="new-email">
                  <i class="fas fa-envelope"></i> Email Address *
                </label>
                <input 
                  type="email" 
                  id="new-email" 
                  name="email" 
                  placeholder="user@eswacaa.sz" 
                  required 
                  aria-describedby="new-email-error new-email-success"
                  autocomplete="email"
                >
                <div class="validation-success" id="new-email-success" style="display: none;">
                  <i class="fas fa-check-circle"></i> Email address is valid
                </div>
                <div class="validation-error" id="new-email-error" style="display: none;">
                  <i class="fas fa-exclamation-circle"></i> Valid email address is required
                </div>
                <small class="form-help">Must be a valid email address, preferably @eswacaa.sz domain</small>
              </div>
              
              <!-- Role Field -->
              <div class="form-group">
                <label for="new-role">
                  <i class="fas fa-user-tag"></i> User Role *
                </label>
                <select id="new-role" name="role" required aria-describedby="new-role-error">
                  <option value="">Select User Role</option>
                  <option value="Administrator">👑 Administrator (Full System Access)</option>
                  <option value="Editor">✏️ Editor (Read/Write Access)</option>
                  <option value="Viewer">👁️ Viewer (Read-Only Access)</option>
                  <option value="Auditor">🔍 Auditor (Audit & Compliance Access)</option>
                  <option value="Finance">💰 Finance (Financial Data Access)</option>
                </select>
                <div class="validation-error" id="new-role-error" style="display: none;">
                  <i class="fas fa-exclamation-circle"></i> Please select a user role
                </div>
                <small class="form-help">Role determines system permissions and access levels</small>
              </div>
              
              <!-- Department Field -->
              <div class="form-group">
                <label for="new-department">
                  <i class="fas fa-building"></i> Department *
                </label>
                <select id="new-department" name="department" required aria-describedby="new-department-error">
                  <option value="">Select Department</option>
                  <option value="Management">🏢 Management</option>
                  <option value="Finance">💰 Finance & Accounting</option>
                  <option value="Operations">⚙️ Operations</option>
                  <option value="Compliance">📋 Compliance & Legal</option>
                  <option value="Audit">🔍 Audit & Risk</option>
                  <option value="IT">💻 Information Technology</option>
                  <option value="Human Resources">👥 Human Resources</option>
                </select>
                <div class="validation-error" id="new-department-error" style="display: none;">
                  <i class="fas fa-exclamation-circle"></i> Please select a department
                </div>
                <small class="form-help">User's organizational department for reporting purposes</small>
              </div>
              
              <!-- Password Field -->
              <div class="form-group">
                <label for="new-password">
                  <i class="fas fa-lock"></i> Password *
                </label>
                <div class="password-input-container">
                  <input 
                    type="password" 
                    id="new-password" 
                    name="password" 
                    placeholder="Enter secure password" 
                    required 
                    aria-describedby="new-password-error"
                    autocomplete="new-password"
                    minlength="8"
                  >
                  <button 
                    type="button" 
                    class="password-toggle-btn" 
                    onclick="togglePassword('new-password')"
                    aria-label="Show password"
                    tabindex="-1"
                  >
                    <i class="fas fa-eye"></i>
                  </button>
                </div>
                <div class="password-strength-meter">
                  <div class="strength-bar">
                    <div class="strength-bar-fill" style="width: 0%;"></div>
                  </div>
                  <p class="strength-text">Password Strength: Enter password</p>
                </div>
                <div class="validation-error" id="new-password-error" style="display: none;">
                  <i class="fas fa-exclamation-circle"></i> Password must meet security requirements
                </div>
                <small class="form-help">Minimum 8 characters with uppercase, lowercase, number, and special character</small>
              </div>
              
              <!-- Confirm Password Field -->
              <div class="form-group">
                <label for="confirm-password">
                  <i class="fas fa-lock"></i> Confirm Password *
                </label>
                <div class="password-input-container">
                  <input 
                    type="password" 
                    id="confirm-password" 
                    name="confirm-password" 
                    placeholder="Confirm your password" 
                    required 
                    aria-describedby="confirm-password-error confirm-password-success"
                    autocomplete="new-password"
                  >
                  <button 
                    type="button" 
                    class="password-toggle-btn" 
                    onclick="togglePassword('confirm-password')"
                    aria-label="Show password"
                    tabindex="-1"
                  >
                    <i class="fas fa-eye"></i>
                  </button>
                </div>
                <div class="validation-success" id="confirm-password-success" style="display: none;">
                  <i class="fas fa-check-circle"></i> Passwords match
                </div>
                <div class="validation-error" id="confirm-password-error" style="display: none;">
                  <i class="fas fa-exclamation-circle"></i> Passwords do not match
                </div>
              </div>
              
              <!-- Account Expiry Field -->
              <div class="form-group">
                <label for="account-expires">
                  <i class="fas fa-calendar-alt"></i> Account Expires (Optional)
                </label>
                <input 
                  type="date" 
                  id="account-expires" 
                  name="expires"
                  min="2024-02-01" 
                  aria-describedby="account-expires-help"
                >
                <small class="form-help" id="account-expires-help">
                  <i class="fas fa-info-circle"></i> Leave empty for permanent account. Set expiry for temporary access.
                </small>
              </div>
              
              <!-- Additional Options -->
              <div class="form-group">
                <label><i class="fas fa-cog"></i> Account Options</label>
                <div class="checkbox-group">
                  <label class="checkbox-label">
                    <input type="checkbox" name="force-password-change" value="1">
                    <span>Force password change on first login</span>
                  </label>
                  <label class="checkbox-label">
                    <input type="checkbox" name="email-notifications" value="1" checked>
                    <span>Send email notifications to user</span>
                  </label>
                  <label class="checkbox-label">
                    <input type="checkbox" name="account-active" value="1" checked>
                    <span>Activate account immediately</span>
                  </label>
                </div>
              </div>
            </div>
            
            <div class="form-actions">
              <button type="button" class="btn btn-secondary" id="cancel-add-user">
                <i class="fas fa-times"></i> Cancel
              </button>
              <button type="button" class="btn btn-warning" id="reset-form">
                <i class="fas fa-undo"></i> Reset Form
              </button>
              <button type="submit" class="btn btn-success" id="create-user-btn" disabled>
                <i class="fas fa-user-plus"></i> Create User Account
              </button>
            </div>
          </form>
        </div>

        <!-- User Accounts Management Table -->
        <div class="user-form-container">
          <div class="section-header">
            <h4><i class="fas fa-users-cog"></i> User Accounts Management</h4>
            <div class="table-actions">
              <button class="btn btn-secondary btn-sm" id="refresh-users" title="Refresh user list">
                <i class="fas fa-sync-alt"></i> Refresh
              </button>
              <button class="btn btn-info btn-sm" id="export-users" title="Export user list">
                <i class="fas fa-download"></i> Export
              </button>
              <button class="btn btn-danger btn-sm" id="bulk-delete-users" style="display: none;" disabled title="Delete selected users">
                <i class="fas fa-trash-alt"></i> Delete Selected (<span id="selected-count">0</span>)
              </button>
            </div>
          </div>
          
          <!-- Advanced Filtering -->
          <div class="table-filters">
            <h6><i class="fas fa-filter"></i> Filter & Search Options</h6>
            <div class="grid-4">
              <div class="form-group">
                <label for="filter-user-role">
                  <i class="fas fa-user-tag"></i> Filter by Role
                </label>
                <select id="filter-user-role">
                  <option value="">All Roles</option>
                  <option value="Administrator">Administrator</option>
                  <option value="Editor">Editor</option>
                  <option value="Viewer">Viewer</option>
                  <option value="Auditor">Auditor</option>
                  <option value="Finance">Finance</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="filter-user-status">
                  <i class="fas fa-toggle-on"></i> Filter by Status
                </label>
                <select id="filter-user-status">
                  <option value="">All Statuses</option>
                  <option value="Active">Active</option>
                  <option value="Inactive">Inactive</option>
                  <option value="Locked">Locked</option>
                  <option value="Expired">Expired</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="filter-user-department">
                  <i class="fas fa-building"></i> Filter by Department
                </label>
                <select id="filter-user-department">
                  <option value="">All Departments</option>
                  <option value="Management">Management</option>
                  <option value="Finance">Finance</option>
                  <option value="Operations">Operations</option>
                  <option value="Compliance">Compliance</option>
                  <option value="Audit">Audit</option>
                  <option value="IT">Information Technology</option>
                </select>
              </div>
              
              <div class="form-group filter-actions">
                <button class="btn btn-primary" id="apply-user-filters" title="Apply selected filters">
                  <i class="fas fa-filter"></i> Apply Filters
                </button>
                <button class="btn btn-secondary" id="clear-user-filters" title="Clear all filters">
                  <i class="fas fa-times"></i> Clear Filters
                </button>
              </div>
            </div>
          </div>
          
          <!-- Users Data Table -->
          <div class="table-container">
            <table class="data-table" id="users-table">
              <thead>
                <tr>
                  <th><input type="checkbox" id="select-all-users" title="Select all users"></th>
                  <th sortable>Username</th>
                  <th sortable>Email</th>
                  <th>Role</th>
                  <th>Department</th>
                  <th>Status</th>
                  <th sortable>Last Login</th>
                  <th>Failed Attempts</th>
                  <th>Expires</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="users-table-tbody">
                <!-- Users will be populated by JavaScript -->
                <tr>
                  <td colspan="10" style="text-align: center; padding: 2rem; color: var(--text-muted);">
                    <i class="fas fa-user-plus" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                    Loading user accounts...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <!-- Table Pagination -->
          <div class="table-pagination" id="users-pagination">
            <div class="pagination-info">
              Showing <span id="users-start">0</span> to <span id="users-end">0</span> of <span id="users-total">0</span> users
            </div>
            <div class="pagination-controls">
              <button class="btn btn-sm btn-secondary" id="users-prev" disabled>
                <i class="fas fa-chevron-left"></i> Previous
              </button>
              <span class="pagination-pages" id="users-pages"></span>
              <button class="btn btn-sm btn-secondary" id="users-next" disabled>
                Next <i class="fas fa-chevron-right"></i>
              </button>
            </div>
          </div>
        </div>

        <!-- Security Audit Log -->
        <div class="user-form-container">
          <div class="section-header">
            <h4><i class="fas fa-shield-alt"></i> Security Audit Log & Activity Monitoring</h4>
            <div class="table-actions">
              <button class="btn btn-secondary btn-sm" id="refresh-audit-log" title="Refresh audit log">
                <i class="fas fa-sync-alt"></i> Refresh Log
              </button>
              <button class="btn btn-info btn-sm" id="export-audit-log" title="Export audit log">
                <i class="fas fa-file-export"></i> Export Log
              </button>
              <button class="btn btn-warning btn-sm" id="clear-audit-log" title="Clear old audit entries">
                <i class="fas fa-trash"></i> Clear Old Entries
              </button>
            </div>
          </div>
          
          <!-- Audit Log Filters -->
          <div class="table-filters">
            <h6><i class="fas fa-search"></i> Audit Log Search & Filters</h6>
            <div class="grid-4">
              <div class="form-group">
                <label for="audit-from-date">
                  <i class="fas fa-calendar-alt"></i> From Date
                </label>
                <input type="date" id="audit-from-date">
              </div>
              
              <div class="form-group">
                <label for="audit-to-date">
                  <i class="fas fa-calendar-alt"></i> To Date
                </label>
                <input type="date" id="audit-to-date">
              </div>
              
              <div class="form-group">
                <label for="audit-action-type">
                  <i class="fas fa-list"></i> Action Type
                </label>
                <select id="audit-action-type">
                  <option value="">All Actions</option>
                  <option value="Login">Login</option>
                  <option value="Logout">Logout</option>
                  <option value="Create User">Create User</option>
                  <option value="Delete User">Delete User</option>
                  <option value="Password Reset">Password Reset</option>
                  <option value="Data Access">Data Access</option>
                  <option value="Failed Login">Failed Login</option>
                </select>
              </div>
              
              <div class="form-group filter-actions">
                <button class="btn btn-primary" id="apply-audit-filters" title="Apply audit filters">
                  <i class="fas fa-search"></i> Search
                </button>
                <button class="btn btn-secondary" id="clear-audit-filters" title="Clear audit filters">
                  <i class="fas fa-eraser"></i> Clear
                </button>
              </div>
            </div>
          </div>
          
          <!-- Audit Log Table -->
          <div class="table-container">
            <table class="data-table" id="audit-log-table">
              <thead>
                <tr>
                  <th sortable>Timestamp</th>
                  <th>User</th>
                  <th>Action</th>
                  <th>Target</th>
                  <th>IP Address</th>
                  <th>Status</th>
                  <th>Details</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="audit-log-tbody">
                <!-- Audit log will be populated by JavaScript -->
                <tr>
                  <td colspan="8" style="text-align: center; padding: 2rem; color: var(--text-muted);">
                    <i class="fas fa-shield-alt" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                    Loading audit log entries...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <!-- Audit Log Pagination -->
          <div class="table-pagination" id="audit-pagination">
            <div class="pagination-info">
              Showing <span id="audit-start">0</span> to <span id="audit-end">0</span> of <span id="audit-total">0</span> audit entries
            </div>
            <div class="pagination-controls">
              <button class="btn btn-sm btn-secondary" id="audit-prev" disabled>
                <i class="fas fa-chevron-left"></i> Previous
              </button>
              <span class="pagination-pages" id="audit-pages"></span>
              <button class="btn btn-sm btn-secondary" id="audit-next" disabled>
                Next <i class="fas fa-chevron-right"></i>
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- Royalty Records -->
      <section id="royalty-records">
        <div class="page-header">
          <div class="page-title">
            <h1>Royalty Records</h1>
            <p>Manage and review all royalty payments</p>
          </div>
          <div class="page-actions">
            <button class="btn btn-success">Record Payment</button>
          </div>
        </div>
        <div class="user-form-container">
          <h4>Record Royalty Payment</h4>
          <div class="grid-4">
            <div class="form-group">
              <label for="entity">Entity</label>
              <select id="entity" aria-describedby="entity-validation">
                <option>Select Entity</option>
                <option>Kwalini Quarry</option>
                <option>Mbabane Quarry</option>
                <option>Sidvokodvo Quarry</option>
                <option>Maloma Colliery</option>
                <option>Ngwenya Mine</option>
                <option>Malolotja Mine</option>
              </select>
              <div class="validation-error" id="entity-validation">Entity is required</div>
            </div>
            <div class="form-group">
              <label for="mineral">Mineral</label>
              <select id="mineral" aria-describedby="mineral-validation">
                <option>Select Mineral</option>
                <option>Coal</option>
                <option>Iron Ore</option>
                <option>Green Chert</option>
                <option>Gravel</option>
                <option>River Sand</option>
                <option>Plaster Sand</option>
                <option>Quarried Stone</option>
              </select>
              <div class="validation-error" id="mineral-validation">Mineral is required</div>
            </div>
            <div class="form-group">
              <label for="volume">Volume (m³)</label>
              <input type="number" id="volume" placeholder="Volume (m³)" aria-describedby="volume-validation">
              <div class="validation-error" id="volume-validation">Volume must be a positive number</div>
            </div>
            <div class="form-group">
              <label for="tariff">Royalty Tariff (E/m³)</label>
              <input type="number" id="tariff" placeholder="Tariff (E/m³)" aria-describedby="tariff-validation">
              <div class="validation-error" id="tariff-validation">Tariff must be a positive number</div>
            </div>
            <div class="form-group">
              <label for="payment-date">Date</label>
              <input type="date" id="payment-date" aria-describedby="date-validation">
              <div class="validation-error" id="date-validation">Date is required</div>
            </div>
          </div>
          <div class="form-actions">
            <button class="btn btn-success" id="save-royalty-btn">Save Royalty</button>
          </div>
        </div>
        <div class="user-form-container">
          <h4>Royalty Records Table</h4>
          <div class="grid-4">
            <div class="form-group">
              <label for="filter-entity">Entity</label>
              <select id="filter-entity">
                <option>All Entities</option>
                <option>Kwalini Quarry</option>
                <option>Mbabane Quarry</option>
                <option>Sidvokodvo Quarry</option>
                <option>Maloma Colliery</option>
                <option>Ngwenya Mine</option>
                <option>Malolotja Mine</option>
              </select>
            </div>
            <div class="form-group">
              <button class="btn btn-primary">Apply Filters</button>
              <button class="btn btn-primary">Export Report</button>
            </div>
          </div>
          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Entity</th>
                  <th>Mineral</th>
                  <th>Volume (m³)</th>
                  <th>Tariff (E/m³)</th>
                  <th>Royalties (E)</th>
                  <th>Date</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="royalty-records-tbody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Contract Management -->
      <section id="contract-management">
        <div class="page-header">
          <div class="page-title">
            <h1>Contract Management</h1>
            <p>Manage royalty agreements for mines and quarries</p>
          </div>
          <div class="page-actions">
            <button class="btn btn-success">Add Contract</button>
          </div>
        </div>
        <div class="user-form-container">
          <h4>Add Contract</h4>
          <div class="grid-4">
            <div class="form-group">
              <label for="contract-entity">Entity</label>
              <select id="contract-entity" aria-describedby="contract-entity-validation">
                <option>Select Entity</option>
                <option>Kwalini Quarry</option>
                <option>Mbabane Quarry</option>
                <option>Sidvokodvo Quarry</option>
                <option>Maloma Colliery</option>
                <option>Ngwenya Mine</option>
                <option>Malolotja Mine</option>
              </select>
              <div class="validation-error" id="contract-entity-validation">Entity is required</div>
            </div>
            <div class="form-group">
              <label for="royalty-rate">Royalty Rate (E/m³)</label>
              <input type="number" id="royalty-rate" placeholder="Royalty Rate (E/m³)" aria-describedby="royalty-rate-validation">
              <div class="validation-error" id="royalty-rate-validation">Rate is required</div>
            </div>
            <div class="form-group">
              <label for="start-date">Start Date</label>
              <input type="date" id="start-date" aria-describedby="start-date-validation">
              <div class="validation-error" id="start-date-validation">Start date is required</div>
            </div>
          </div>
          <div class="form-actions">
            <button class="btn btn-success">Save Contract</button>
          </div>
        </div>
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>Entity</th>
                <th>Royalty Rate (E/m³)</th>
                <th>Start Date</th>
                <th>Document</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <!-- Audit Dashboard -->
      <section id="audit-dashboard">
        <div class="page-header">
          <div class="page-title">
            <h1>Audit Dashboard</h1>
            <p>Review discrepancies and audit reports</p>
          </div>
          <div class="page-actions">
            <button class="btn btn-primary">Export Report</button>
          </div>
        </div>
        <div class="user-form-container">
          <div class="grid-4">
            <div class="form-group">
              <label for="audit-filter-entity">Entity</label>
              <select id="audit-filter-entity">
                <option>All Entities</option>
                <option>Kwalini Quarry</option>
                <option>Mbabane Quarry</option>
                <option>Sidvokodvo Quarry</option>
                <option>Maloma Colliery</option>
                <option>Ngwenya Mine</option>
                <option>Malolotja Mine</option>
              </select>
            </div>
            <div class="form-group">
              <button class="btn btn-primary">Apply Filters</button>
            </div>
          </div>
          <h4>Discrepancies</h4>
          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Project</th>
                  <th>Mineral</th>
                  <th>Declared (m³)</th>
                  <th>Verified (m³)</th>
                  <th>Outstanding (E)</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Reporting & Analytics Placeholder -->
      <section id="reporting-analytics">
        <div class="page-header">
          <div class="page-title">
            <h1><i class="fas fa-chart-bar"></i> Reporting & Analytics</h1>
            <p>Generate comprehensive reports, analyze data, and visualize key performance indicators.</p>
          </div>
          <div class="page-actions">
            <button class="btn btn-primary" id="export-all-data-btn"><i class="fas fa-file-excel"></i> Export All Data</button>
            <button class="btn btn-info" id="customize-dashboard-btn"><i class="fas fa-tachometer-alt"></i> Customize Dashboard</button>
          </div>
        </div>

        <!-- Report Generation -->
        <div class="user-form-container">
          <div class="section-header">
            <h4><i class="fas fa-file-alt"></i> Generate Reports</h4>
            <div class="table-actions">
              <button class="btn btn-secondary btn-sm" id="view-scheduled-reports-btn"><i class="fas fa-clock"></i> Scheduled Reports</button>
            </div>
          </div>
          <form id="report-generation-form">
            <div class="grid-4">
              <div class="form-group">
                <label for="report-type"><i class="fas fa-list-alt"></i> Report Type</label>
                <select id="report-type" name="reportType">
                  <option value="">Select Report Type</option>
                  <option value="royalty_summary">Royalty Summary</option>
                  <option value="production_volume">Production Volume</option>
                  <option value="sales_analysis">Sales Analysis</option>
                  <option value="contract_performance">Contract Performance</option>
                  <option value="payment_history">Payment History</option>
                  <option value="compliance_status">Compliance Status</option>
                  <option value="audit_trail_summary">Audit Trail Summary</option>
                </select>
              </div>
              <div class="form-group">
                <label for="report-entity-filter"><i class="fas fa-industry"></i> Filter by Entity</label>
                <select id="report-entity-filter" name="entityFilter">
                  <option value="all">All Entities</option>
                  <option value="kwalini">Kwalini Quarry</option>
                  <option value="mbabane">Mbabane Quarry</option>
                  <option value="maloma">Maloma Colliery</option>
                  <!-- Add more entities as needed -->
                </select>
              </div>
              <div class="form-group">
                <label for="report-date-range"><i class="fas fa-calendar-alt"></i> Date Range</label>
                <div class="date-range-inputs">
                  <input type="date" id="report-start-date" name="startDate" aria-label="Start Date">
                  <span>to</span>
                  <input type="date" id="report-end-date" name="endDate" aria-label="End Date">
                </div>
              </div>
              <div class="form-group">
                <label for="report-format"><i class="fas fa-file-export"></i> Export Format</label>
                <select id="report-format" name="reportFormat">
                  <option value="pdf">PDF</option>
                  <option value="xlsx">Excel (XLSX)</option>
                  <option value="csv">CSV</option>
                </select>
              </div>
            </div>
            <div class="form-actions">
              <button type="submit" class="btn btn-success"><i class="fas fa-cogs"></i> Generate Report</button>
              <button type="button" class="btn btn-secondary" id="preview-report-btn"><i class="fas fa-eye"></i> Preview Report</button>
              <button type="button" class="btn btn-info" id="schedule-report-btn"><i class="fas fa-calendar-plus"></i> Schedule Report</button>
            </div>
          </form>
        </div>

        <!-- Data Analysis & KPI Dashboards -->
        <div class="user-form-container">
          <div class="section-header">
            <h4><i class="fas fa-chart-line"></i> Data Analysis & KPI Dashboards</h4>
          </div>
          <div class="charts-grid">
            <div class="analytics-chart card">
              <div class="chart-header">
                <h5><i class="fas fa-coins"></i> Royalty Payments Over Time</h5>
                <div class="chart-controls">
                  <select class="metric-period" id="royalty-analysis-period">
                    <option value="monthly">Monthly</option>
                    <option value="quarterly">Quarterly</option>
                    <option value="yearly">Yearly</option>
                  </select>
                </div>
              </div>
              <div class="chart-container">
                <canvas id="royalty-payments-chart" aria-label="Royalty payments analysis chart"></canvas>
              </div>
              <div class="chart-summary">
                <small><i class="fas fa-info-circle"></i> Total collected: E <span id="total-collected-analysis">0.00</span></small>
              </div>
            </div>
            <div class="analytics-chart card">
              <div class="chart-header">
                <h5><i class="fas fa-cube"></i> Production vs. Sales Volume</h5>
                <div class="chart-controls">
                  <select class="metric-period" id="production-sales-period">
                    <option value="last_3_months">Last 3 Months</option>
                    <option value="last_6_months">Last 6 Months</option>
                    <option value="ytd">Year to Date</option>
                  </select>
                </div>
              </div>
              <div class="chart-container">
                <canvas id="production-sales-chart" aria-label="Production vs. Sales volume chart"></canvas>
              </div>
              <div class="chart-summary">
                <small><i class="fas fa-info-circle"></i> Variance: <span id="production-sales-variance">0</span>%</small>
              </div>
            </div>
          </div>
          <div class="charts-grid">
            <div class="metric-card card">
                <div class="card-header"><h3><i class="fas fa-file-contract"></i> Contract Performance KPI</h3></div>
                <div class="card-body">
                    <p id="avg-contract-value">E 0.00</p>
                    <small>Average Contract Value</small>
                </div>
            </div>
            <div class="metric-card card">
                <div class="card-header"><h3><i class="fas fa-check-double"></i> Compliance Adherence KPI</h3></div>
                <div class="card-body">
                    <p id="compliance-adherence-rate">0%</p>
                    <small>Overall Compliance Rate</small>
                </div>
            </div>
             <div class="metric-card card">
                <div class="card-header"><h3><i class="fas fa-users"></i> Active Contracts</h3></div>
                <div class="card-body">
                    <p id="active-contracts-count">0</p>
                    <small>Total Active Agreements</small>
                </div>
            </div>
             <div class="metric-card card">
                <div class="card-header"><h3><i class="fas fa-exclamation-circle"></i> Expiring Soon</h3></div>
                <div class="card-body">
                    <p id="expiring-contracts-count">0</p>
                    <small>Contracts Expiring in 90 Days</small>
                </div>
            </div>
          </div>
        </div>
        
        <!-- Audit Trail Reporting -->
        <div class="user-form-container">
            <div class="section-header">
                <h4><i class="fas fa-history"></i> Audit Trail Reporting</h4>
                <div class="table-actions">
                     <button class="btn btn-primary btn-sm" id="full-audit-log-link-btn"><i class="fas fa-external-link-alt"></i> View Full Audit Log</button>
                </div>
            </div>
            <p>Generate specific reports from the audit trail to track system activities, data changes, and calculations for transparency and compliance.</p>
            <!-- Simplified form for audit trail reports, more detailed filtering can be on the main audit log page -->
            <form id="audit-report-form">
                <div class="grid-3">
                    <div class="form-group">
                        <label for="audit-report-type"><i class="fas fa-tags"></i> Focus Area</label>
                        <select id="audit-report-type" name="auditReportType">
                            <option value="all">All Activities</option>
                            <option value="data_changes">Data Changes</option>
                            <option value="user_activity">User Activity</option>
                            <option value="calculation_history">Calculation History</option>
                            <option value="security_events">Security Events</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="audit-report-user"><i class="fas fa-user-secret"></i> Specific User (Optional)</label>
                        <input type="text" id="audit-report-user" name="auditUser" placeholder="Enter username">
                    </div>
                    <div class="form-group">
                        <label for="audit-report-date-range"><i class="fas fa-calendar-alt"></i> Date Range</label>
                         <div class="date-range-inputs">
                            <input type="date" id="audit-report-start-date" name="auditStartDate" aria-label="Start Date">
                            <span>to</span>
                            <input type="date" id="audit-report-end-date" name="auditEndDate" aria-label="End Date">
                        </div>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-success"><i class="fas fa-search"></i> Generate Audit Report</button>
                </div>
            </form>
            <div class="table-container" id="audit-report-results" style="margin-top: 1.5rem; display: none;">
                <h5>Audit Report Results</h5>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>User</th>
                            <th>Action</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody id="audit-report-tbody">
                        <!-- Results will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
      </section>

      <!-- Communication Section (Missing Implementation) -->
      <section id="communication">
        <div class="page-header">
          <div class="page-title">
            <h1>📧 Communication Center</h1>
            <p>Centralized communication hub for stakeholder engagement and regulatory correspondence</p>
          </div>
          <div class="page-actions">
            <button class="btn btn-success" id="compose-message-btn">
              <i class="fas fa-pen"></i> Compose Message
            </button>
            <button class="btn btn-info" id="sync-messages-btn">
              <i class="fas fa-sync-alt"></i> Sync Messages
            </button>
            <button class="btn btn-primary" id="communication-settings-btn">
              <i class="fas fa-cog"></i> Settings
            </button>
          </div>
        </div>

        <!-- Communication Dashboard -->
        <div class="charts-grid">
          <div class="metric-card card">
            <div class="card-header">
              <h3><i class="fas fa-envelope"></i> Unread Messages</h3>
            </div>
            <div class="card-body">
              <p id="unread-messages-count">7</p>
              <small><i class="fas fa-clock"></i> 3 urgent, 4 normal priority</small>
            </div>
          </div>
          <div class="metric-card card">
            <div class="card-header">
              <h3><i class="fas fa-paper-plane"></i> Sent Today</h3>
            </div>
            <div class="card-body">
              <p id="sent-messages-count">12</p>
              <small><i class="fas fa-check-circle text-success"></i> All delivered successfully</small>
            </div>
          </div>
          <div class="metric-card card">
            <div class="card-header">
              <h3><i class="fas fa-calendar-check"></i> Pending Responses</h3>
            </div>
            <div class="card-body">
              <p id="pending-responses-count">3</p>
              <small><i class="fas fa-exclamation-triangle text-warning"></i> 1 overdue response</small>
            </div>
          </div>
          <div class="metric-card card">
            <div class="card-header">
              <h3><i class="fas fa-users"></i> Active Conversations</h3>
            </div>
            <div class="card-body">
              <p id="active-conversations-count">15</p>
              <small><i class="fas fa-comments"></i> Across 8 different entities</small>
            </div>
          </div>
        </div>

        <!-- Message Center -->
        <!-- Message Center -->
        <div class="user-form-container">
          <div class="communication-tabs">
            <button class="tab-btn active" data-tab="#inbox-tab">
              <i class="fas fa-inbox"></i> Inbox (7)
            </button>
            <button class="tab-btn" data-tab="#sent-tab">
              <i class="fas fa-paper-plane"></i> Sent
            </button>
            <button class="tab-btn" data-tab="#drafts-tab">
              <i class="fas fa-edit"></i> Drafts (2)
            </button>
            <button class="tab-btn" data-tab="#templates-tab">
              <i class="fas fa-copy"></i> Templates
            </button>
            <button class="tab-btn" data-tab="#scheduled-tab">
              <i class="fas fa-clock"></i> Scheduled
            </button>
          </div>

          <!-- Inbox Tab -->
          <div class="tab-content active" id="inbox-tab">
            <div class="message-list">
              <div class="message-item unread urgent">
                <div class="message-header">
                  <div class="sender-info">
                    <strong>Ministry of Natural Resources</strong>
                    <span class="message-time">2 hours ago</span>
                  </div>
                  <div class="message-priority">
                    <span class="priority-badge urgent">URGENT</span>
                  </div>
                </div>
                <div class="message-subject">
                  <h6>Immediate Compliance Review Required - Maloma Colliery</h6>
                </div>
                <div class="message-preview">
                  <p>Following recent inspection findings, immediate action is required for compliance verification...</p>
                </div>
                <div class="message-actions">
                  <button class="btn btn-sm btn-primary">Reply</button>
                  <button class="btn btn-sm btn-secondary">Mark Read</button>
                  <button class="btn btn-sm btn-info">View Details</button>
                </div>
              </div>

              <div class="message-item unread">
                <div class="message-header">
                  <div class="sender-info">
                    <strong>Kwalini Quarry Management</strong>
                    <span class="message-time">5 hours ago</span>
                  </div>
                </div>
                <div class="message-subject">
                  <h6>Monthly Production Report Submission</h6>
                </div>
                <div class="message-preview">
                  <p>Please find attached our monthly production report for February 2024...</p>
                </div>
                <div class="message-actions">
                  <button class="btn btn-sm btn-primary">Reply</button>
                  <button class="btn btn-sm btn-secondary">Mark Read</button>
                  <button class="btn btn-sm btn-success">Download Attachment</button>
                </div>
              </div>

              <div class="message-item">
                <div class="message-header">
                  <div class="sender-info">
                    <strong>Environmental Protection Agency</strong>
                    <span class="message-time">1 day ago</span>
                  </div>
                </div>
                <div class="message-subject">
                  <h6>Environmental Impact Assessment Update</h6>
                </div>
                <div class="message-preview">
                  <p>Updated guidelines for environmental impact assessments are now available...</p>
                </div>
                <div class="message-actions">
                  <button class="btn btn-sm btn-secondary">Archive</button>
                  <button class="btn btn-sm btn-info">View Guidelines</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Sent Tab -->
          <div class="tab-content" id="sent-tab">
            <div class="message-list">
              <div class="message-item sent">
                <div class="message-header">
                  <div class="sender-info">
                    <strong>To: All Mining Entities</strong>
                    <span class="message-time">3 hours ago</span>
                  </div>
                  <div class="delivery-status">
                    <span class="status-badge delivered">Delivered</span>
                  </div>
                </div>
                <div class="message-subject">
                  <h6>Updated Royalty Rate Schedule - Effective March 2024</h6>
                </div>
                <div class="message-actions">
                  <button class="btn btn-sm btn-info">View Message</button>
                  <button class="btn btn-sm btn-secondary">Send Follow-up</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Message Templates Tab -->
          <div class="tab-content" id="templates-tab">
            <div class="template-grid">
              <div class="template-card">
                <h6>Compliance Reminder</h6>
                <p>Standard reminder for upcoming compliance deadlines</p>
                <button class="btn btn-sm btn-primary">Use Template</button>
              </div>
              <div class="template-card">
                <h6>Payment Overdue Notice</h6>
                <p>Formal notice for overdue royalty payments</p>
                <button class="btn btn-sm btn-primary">Use Template</button>
              </div>
              <div class="template-card">
                <h6>Rate Change Notification</h6>
                <p>Official notification of royalty rate changes</p>
                <button class="btn btn-sm btn-primary">Use Template</button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Notifications Section (Complete Implementation) -->
      <section id="notifications">
        <div class="page-header">
          <div class="page-title">
            <h1>🔔 Notifications Center</h1>
            <p>Real-time alerts, system notifications, and important updates</p>
          </div>
          <div class="page-actions">
            <button class="btn btn-primary" id="mark-all-read">
              <i class="fas fa-check-double"></i> Mark All Read
            </button>
            <button class="btn btn-secondary" id="notification-settings">
              <i class="fas fa-cog"></i> Settings
            </button>
          </div>
        </div>

        <!-- Notification Statistics -->
        <div class="charts-grid">
          <div class="metric-card card">
            <div class="card-header">
              <h3><i class="fas fa-bell"></i> Unread Notifications</h3>
            </div>
            <div class="card-body">
              <p id="unread-count">8</p>
              <small>3 high priority, 5 normal</small>
            </div>
          </div>
          <div class="metric-card card">
            <div class="card-header">
              <h3><i class="fas fa-exclamation-triangle"></i> Critical Alerts</h3>
            </div>
            <div class="card-body">
              <p id="critical-alerts-count">2</p>
              <small class="text-danger">Requires immediate attention</small>
            </div>
          </div>
          <div class="metric-card card">
            <div class="card-header">
              <h3><i class="fas fa-calendar-alt"></i> Due Today</h3>
            </div>
            <div class="card-body">
              <p id="due-today-count">4</p>
              <small>Compliance deadlines and tasks</small>
            </div>
          </div>
          <div class="metric-card card">
            <div class="card-header">
              <h3><i class="fas fa-chart-line"></i> System Health</h3>
            </div>
            <div class="card-body">
              <p id="system-health-score">98%</p>
              <small class="text-success">All systems operational</small>
            </div>
          </div>
        </div>

        <!-- Notifications List -->
        <div class="user-form-container">
          <div class="notification-filters">
            <h6><i class="fas fa-filter"></i> Filter Notifications</h6>
            <div class="grid-4">
              <div class="form-group">
                <select id="notification-type-filter">
                  <option value="">All Types</option>
                  <option value="system">System Alerts</option>
                  <option value="compliance">Compliance</option>
                  <option value="payment">Payments</option>
                  <option value="security">Security</option>
                </select>
              </div>
              <div class="form-group">
                <select id="notification-priority-filter">
                  <option value="">All Priorities</option>
                  <option value="critical">Critical</option>
                  <option value="high">High</option>
                  <option value="normal">Normal</option>
                  <option value="low">Low</option>
                </select>
              </div>
              <div class="form-group">
                <select id="notification-status-filter">
                  <option value="">All Status</option>
                  <option value="unread">Unread</option>
                  <option value="read">Read</option>
                  <option value="archived">Archived</option>
                </select>
              </div>
              <div class="form-group">
                <button class="btn btn-primary" id="apply-notification-filters">Apply</button>
              </div>
            </div>
          </div>

          <div class="notifications-container">
            <div class="notification-item unread critical">
              <div class="notification-icon">
                <i class="fas fa-exclamation-triangle text-danger"></i>
              </div>
              <div class="notification-content">
                <div class="notification-header">
                  <h6>Critical: Payment Overdue Alert</h6>
                  <span class="notification-time">30 minutes ago</span>
                </div>
                <p>Ngwenya Mine has exceeded the 30-day payment deadline. Immediate action required.</p>
                <div class="notification-actions">
                  <button class="btn btn-sm btn-danger">Send Notice</button>
                  <button class="btn btn-sm btn-secondary">Mark Read</button>
                  <button class="btn btn-sm btn-info">View Details</button>
                </div>
              </div>
            </div>

            <div class="notification-item unread high">
              <div class="notification-icon">
                <i class="fas fa-calendar-times text-warning"></i>
              </div>
              <div class="notification-content">
                <div class="notification-header">
                  <h6>Compliance Deadline Approaching</h6>
                  <span class="notification-time">2 hours ago</span>
                </div>
                <p>Environmental Impact Report due in 3 days for Maloma Colliery.</p>
                <div class="notification-actions">
                  <button class="btn btn-sm btn-warning">Remind Entity</button>
                  <button class="btn btn-sm btn-secondary">Mark Read</button>
                  <button class="btn btn-sm btn-info">View Report Status</button>
                </div>
              </div>
            </div>

            <div class="notification-item unread normal">
              <div class="notification-icon">
                <i class="fas fa-user-plus text-info"></i>
              </div>
              <div class="notification-content">
                <div class="notification-header">
                  <h6>New User Account Created</h6>
                  <span class="notification-time">4 hours ago</span>
                </div>
                <p>User account 'audit.officer' has been successfully created and activated.</p>
                <div class="notification-actions">
                  <button class="btn btn-sm btn-secondary">Mark Read</button>
                  <button class="btn btn-sm btn-info">View User Details</button>
                </div>
              </div>
            </div>

            <div class="notification-item read normal">
              <div class="notification-icon">
                <i class="fas fa-chart-line text-success"></i>
              </div>
              <div class="notification-content">
                <div class="notification-header">
                  <h6>Monthly Report Generated</h6>
                  <span class="notification-time">1 day ago</span>
                </div>
                <p>February 2024 royalty collection report has been generated and is ready for review.</p>
                <div class="notification-actions">
                  <button class="btn btn-sm btn-success">Download Report</button>
                  <button class="btn btn-sm btn-secondary">Archive</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Compliance & Regulatory Section (Complete Implementation) -->
      <section id="compliance">
        <div class="page-header">
          <div class="page-title">
            <h1>✅ Compliance & Regulatory Management</h1>
            <p>Comprehensive compliance tracking, regulatory requirements, and deadline management</p>
          </div>
          <div class="page-actions">
            <button class="btn btn-success" id="generate-compliance-report">
              <i class="fas fa-file-alt"></i> Generate Report
            </button>
            <button class="btn btn-primary" id="schedule-inspection">
              <i class="fas fa-calendar-plus"></i> Schedule Inspection
            </button>
            <button class="btn btn-warning" id="compliance-alerts">
              <i class="fas fa-bell"></i> View Alerts
            </button>
          </div>
        </div>

        <!-- Compliance Overview -->
        <div class="charts-grid">
          <div class="metric-card card">
            <div class="card-header">
              <h3><i class="fas fa-percentage"></i> Overall Compliance Rate</h3>
            </div>
            <div class="card-body">
              <p id="overall-compliance-rate">94.2%</p>
              <div class="mini-progress">
                <div class="progress-bar" style="width: 94.2%; background: var(--success-color);"></div>
              </div>
              <small class="text-success">Above industry standard</small>
            </div>
          </div>
          <div class="metric-card card">
            <div class="card-header">
              <h3><i class="fas fa-clock"></i> Upcoming Deadlines</h3>
            </div>
            <div class="card-body">
              <p id="upcoming-deadlines-count">7</p>
              <small>Next 30 days: 3 critical, 4 standard</small>
            </div>
          </div>
          <div class="metric-card card">
            <div class="card-header">
              <h3><i class="fas fa-exclamation-triangle"></i> Overdue Items</h3>
            </div>
            <div class="card-body">
              <p id="overdue-items-count">2</p>
              <small class="text-danger">Requires immediate attention</small>
            </div>
          </div>
          <div class="metric-card card">
            <div class="card-header">
              <h3><i class="fas fa-shield-check"></i> Inspections Completed</h3>
            </div>
            <div class="card-body">
              <p id="inspections-completed">15</p>
              <small>This quarter: 12 passed, 3 conditional</small>
            </div>
          </div>
        </div>

        <!-- Regulatory Requirements Tracking -->
        <div class="user-form-container">
          <div class="section-header">
            <h4><i class="fas fa-list-check"></i> Regulatory Requirements Status</h4>
            <div class="table-actions">
              <button class="btn btn-secondary btn-sm" id="refresh-compliance">
                <i class="fas fa-sync-alt"></i> Refresh
              </button>
              <button class="btn btn-info btn-sm" id="export-compliance">
                <i class="fas fa-download"></i> Export
              </button>
            </div>
          </div>

          <div class="table-container">
            <table class="data-table" id="compliance-table">
              <thead>
                <tr>
                  <th>Requirement</th>
                  <th>Regulatory Body</th>
                  <th>Due Date</th>
                  <th>Status</th>
                  <th>Submitted Date</th>
                  <th>Reference Number</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>Monthly Royalty Return</td>
                  <td>Ministry of Natural Resources</td>
                  <td>15 Mar 2024</td>
                  <td><span class="status-badge warning">Due Soon</span></td>
                  <td>-</td>
                  <td>-</td>
                  <td>
                    <button class="btn btn-primary btn-sm">Prepare</button>
                    <button class="btn btn-success btn-sm">Submit</button>
                  </td>
                </tr>
                <tr>
                  <td>Environmental Report</td>
                  <td>Environmental Authority</td>
                  <td>28 Feb 2024</td>
                  <td><span class="status-badge danger">Overdue</span></td>
                  <td>-</td>
                  <td>-</td>
                  <td>
                    <button class="btn btn-danger btn-sm">Submit Urgent</button>
                    <button class="btn btn-secondary btn-sm">Request Extension</button>
                  </td>
                </tr>
                <tr>
                  <td>Quarterly Production</td>
                  <td>Ministry of Natural Resources</td>
                  <td>31 Jan 2024</td>
                  <td><span class="status-badge success">Submitted</span></td>
                  <td>29 Jan 2024</td>
                  <td>MNR-Q4-2023-001</td>
                  <td>
                    <button class="btn btn-secondary btn-sm">View</button>
                  </td>
                </tr>
                <tr>
                  <td>Safety Inspection Report</td>
                  <td>Department of Labour</td>
                  <td>20 Mar 2024</td>
                  <td><span class="status-badge info">In Progress</span></td>
                  <td>-</td>
                  <td>-</td>
                  <td>
                    <button class="btn btn-secondary btn-sm">Continue</button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Compliance Alerts & Notifications -->
        <div class="user-form-container">
          <h4>🚨 Compliance Alerts & Deadlines</h4>
          <div class="alert-dashboard">
            <div class="alert-item urgent">
              <div class="alert-icon">🔴</div>
              <div class="alert-content">
                <h6>Environmental Impact Report Overdue</h6>
                <p>Due: 28 Feb 2024 | Days Overdue: 2</p>
                <div class="alert-actions">
                  <button class="btn btn-danger btn-sm">Submit Now</button>
                  <button class="btn btn-secondary btn-sm">Request Extension</button>
                </div>
              </div>
            </div>
            <div class="alert-item warning">
              <div class="alert-icon">🟡</div>
              <div class="alert-content">
                <h6>Monthly Royalty Return Due Soon</h6>
                <p>Due: 15 Mar 2024 | Days Remaining: 5</p>
                <div class="alert-actions">
                  <button class="btn btn-primary btn-sm">Prepare Report</button>
                </div>
              </div>
            </div>
            <div class="alert-item info">
              <div class="alert-icon">🔵</div>
              <div class="alert-content">
                <h6>New Mining Act Amendment</h6>
                <p>Effective: 1 Apr 2024 | Review required for compliance impact</p>
                <div class="alert-actions">
                  <button class="btn btn-secondary btn-sm">Review Changes</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Regulatory Calendar -->
        <div class="user-form-container">
          <h4>📅 Regulatory Calendar</h4>
          <div class="calendar-view">
            <div class="calendar-header">
              <button class="btn btn-secondary" id="prev-month">&lt; Previous</button>
              <h5 id="calendar-month-year">March 2024</h5>
              <button class="btn btn-secondary" id="next-month">Next &gt;</button>
            </div>
            <div class="calendar-grid">
              <div class="calendar-week">
                <div class="calendar-day">
                  <span class="day-number">15</span>
                  <div class="day-events">
                    <div class="event royalty">Royalty Return Due</div>
                  </div>
                </div>
                <div class="calendar-day">
                  <span class="day-number">20</span>
                  <div class="day-events">
                    <div class="event safety">Safety Inspection</div>
                  </div>
                </div>
                <div class="calendar-day">
                  <span class="day-number">31</span>
                  <div class="day-events">
                    <div class="event environmental">Environmental Report</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Regulatory Management Placeholder -->
      <section id="regulatory-management">
        <div class="page-header">
          <div class="page-title">
            <h1><i class="fas fa-gavel"></i> Regulatory Management</h1>
            <p>Manage regulatory frameworks, tax structures, and jurisdictional compliance.</p>
          </div>
          <div class="page-actions">
            <button class="btn btn-primary"><i class="fas fa-plus"></i> Add New Regulation</button>
          </div>
        </div>
        <div class="user-form-container">
          <h4>Regulatory Management Content</h4>
          <p>This section is under development. Tools for managing regulations will be available here.</p>
          <!-- Placeholder for regulatory content -->
          <div class="jurisdiction-matrix">
                       <div class="jurisdiction-card">
              <div class="jurisdiction-header">
                <h6>National Mining Act 2023</h6>
                <span class="compliance-score">98% Compliant</span>
              </div>
              <p>Details about the National Mining Act and its requirements...</p>
            </div>
          </div>
        </div>
      </section>

      <!-- My Profile -->
      <section id="profile">
        <div class="page-header">
          <div class="page-title">
            <h1>My Profile</h1>
            <p>Manage your account details and preferences</p>
          </div>
          <div class="page-actions">
            <button class="btn btn-primary">Save Changes</button>
          </div>
        </div>
        <div class="user-form-container">
          <h4>Profile Information</h4>
          <div class="grid-4">
            <div class="form-group">
              <label for="profile-username">Username</label>
              <input type="text" id="profile-username" placeholder="Username" aria-describedby="profile-username-validation">
              <div class="validation-error" id="profile-username-validation">Username is required</div>
            </div>
            <div class="form-group">
              <label for="profile-email">Email</label>
              <input type="email" id="profile-email" placeholder="Email" aria-describedby="profile-email-validation">
              <div class="validation-error" id="profile-email-validation">Email is required</div>
            </div>
            <div class="form-group">
              <label for="profile-department">Department</label>
              <select id="profile-department" aria-describedby="profile-department-validation">
                <option>Select Department</option>
                <option>Finance</option>
                <option>Operations</option>
                <option>Compliance</option>
                <option>Audit</option>
                <option>Management</option>
              </select>
              <div class="validation-error" id="profile-department-validation">Department is required</div>
            </div>
          </div>
          <h4>Change Password</h4>
          <div class="grid-4">
            <div class="form-group">
              <label for="current-password">Current Password</label>
              <input type="password" id="current-password" placeholder="Current Password" aria-describedby="current-password-validation">
              <div class="validation-error" id="current-password-validation">Current password is required</div>
            </div>
            <div class="form-group">
              <label for="new-profile-password">New Password</label>
              <input type="password" id="new-profile-password" placeholder="New Password" aria-describedby="new-profile-password-validation">
              <div class="validation-error" id="new-profile-password-validation">New password is required</div>
            </div>
            <div class="form-group">
              <label for="confirm-profile-password">Confirm New Password</label>
              <input type="password" id="confirm-profile-password" placeholder="Confirm New Password" aria-describedby="confirm-profile-password-validation">
              <div class="validation-error" id="confirm-profile-password-validation">Passwords must match</div>
            </div>
          </div>
          <div class="form-actions">
            <button class="btn btn-secondary">Cancel</button>
            <button class="btn btn-success">Update Profile</button>
          </div>
        </div>
      </section>

      <!-- Logout -->
      <section id="logout">
        <div class="page-header">
          <div class="page-title">
            <h1>Logout</h1>
            <p>Securely end your session</p>
          </div>
          <div class="page-actions">
            <button class="btn btn-danger" id="confirm-logout-btn">Confirm Logout</button>
          </div>
        </div>
        <div class="user-form-container">
          <p>Click the button above to log out of the Mining Royalties Manager. Ensure all changes are saved before logging out.</p>
          <div class="logout-warning">
            <h5>⚠️ Before you logout:</h5>
            <ul>
              <li>Save any unsaved changes</li>
              <li>Complete any pending operations</li>
              <li>Close any open reports or forms</li>
            </ul>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Modern Modular JavaScript -->
  <!-- Note: The file js/app.js needs to be created and populated with the application's main JavaScript logic. -->
  <script type="module" src="js/app.js"></script>
  
  <!-- Legacy support for non-module browsers -->
  <script nomodule>
    console.warn('This browser does not support ES6 modules. Please upgrade to a modern browser.');
    
    // Simple fallback for basic functionality
    document.addEventListener('DOMContentLoaded', function() {
      const loadingScreen = document.getElementById('loading-screen');
      const loginSection = document.getElementById('login-section');
      
      setTimeout(() => {
        loadingScreen.style.display = 'none';
        loginSection.style.display = 'flex';
      }, 2000);
      
      // Basic login functionality
      const loginForm = document.querySelector('.login-form');
      if (loginForm) {
        loginForm.addEventListener('submit', function(e) {
          e.preventDefault();
          const appContainer = document.getElementById('app-container');
          loginSection.style.display = 'none';
          appContainer.style.display = 'flex';
        });
      }
    });
  </script>

  <script>
// Enhanced password toggle functionality
function togglePassword(inputId) {
  const input = document.getElementById(inputId);
  if (!input) return;
  
  const container = input.parentElement;
  const button = container.querySelector('.password-toggle-btn');
  const icon = button.querySelector('i');
  
  if (input.type === 'password') {
    input.type = 'text';
    icon.className = 'fas fa-eye-slash';
    button.setAttribute('aria-label', 'Hide password');
  } else {
    input.type = 'password';
    icon.className = 'fas fa-eye';
    button.setAttribute('aria-label', 'Show password');
  }
}

// Enhanced form validation helpers
function validateUsername(username) {
  if (!username || username.trim().length === 0) {
    return { valid: false, message: 'Username is required' };
  }
  if (username.length < 3) {
    return { valid: false, message: 'Username must be at least 3 characters long' };
  }
  if (username.length > 50) {
    return { valid: false, message: 'Username must be less than 50 characters' };
  }
  if (!/^[a-zA-Z0-9._-]+$/.test(username)) {
    return { valid: false, message: 'Username can only contain letters, numbers, dots, dashes, and underscores' };
  }
  // Check for reserved usernames
  const reserved = ['admin', 'root', 'system', 'test', 'demo'];
  if (reserved.includes(username.toLowerCase())) {
    return { valid: false, message: 'This username is reserved' };
  }
  return { valid: true, message: 'Username is available' };
}

function validateEmail(email) {
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!email || email.trim().length === 0) {
    return { valid: false, message: 'Email address is required' };
  }
  if (!emailRegex.test(email)) {
    return { valid: false, message: 'Please enter a valid email address' };
  }
  // Check for valid domain
  const domain = email.split('@')[1];
  if (domain && domain.indexOf('.') === -1) {
    return { valid: false, message: 'Please enter a valid email domain' };
  }
  return { valid: true, message: 'Email address is valid' };
}

function validatePassword(password) {
  if (!password) {
    return { valid: false, message: 'Password is required', strength: 'none', score: 0 };
  }
  
  let score = 0;
  let feedback = [];
  
  // Length check
  if (password.length >= 8) {
    score += 1;
  } else {
    feedback.push('at least 8 characters');
  }
  
  // Lowercase check
  if (/[a-z]/.test(password)) {
    score += 1;
  } else {
    feedback.push('lowercase letters');
  }
  
  // Uppercase check
  if (/[A-Z]/.test(password)) {
    score += 1;
  } else {
    feedback.push('uppercase letters');
  }
  
  // Number check
  if (/[0-9]/.test(password)) {
    score += 1;
  } else {
    feedback.push('numbers');
  }
  
  // Special character check
  if (/[^a-zA-Z0-9]/.test(password)) {
    score += 1;
  } else {
    feedback.push('special characters');
  }
  
  let strength = 'weak';
  if (score >= 4) strength = 'strong';
  else if (score >= 3) strength = 'medium';
  
  const isValid = score >= 3;
  const message = isValid 
    ? 'Password strength is good' 
    : `Password needs: ${feedback.join(', ')}`;
  
  return { 
    valid: isValid, 
    message: message,
    strength: strength,
    score: score
  };
}

function validateRequired(value, fieldName) {
  if (!value || value.trim().length === 0) {
    return { valid: false, message: `${fieldName} is required` };
  }
  return { valid: true, message: `${fieldName} is valid` };
}

function showFieldValidation(fieldId, validation) {
  const field = document.getElementById(fieldId);
  const errorElement = document.getElementById(fieldId + '-error');
  const successElement = document.getElementById(fieldId + '-success');
  
  if (!field) return;
  
  // Clear previous states
  field.classList.remove('field-valid', 'field-invalid');
  
  if (validation.valid) {
    field.classList.add('field-valid');
    if (errorElement) errorElement.style.display = 'none';
    if (successElement) {
      successElement.textContent = `✓ ${validation.message}`;
      successElement.style.display = 'block';
    }
  } else {
    field.classList.add('field-invalid');
    if (successElement) successElement.style.display = 'none';
    if (errorElement) {
      errorElement.textContent = validation.message;
      errorElement.style.display = 'block';
    }
  }
  
  // Update form submit button state
  updateSubmitButtonState();
}

function updatePasswordStrength(password) {
  const validation = validatePassword(password);
  const strengthBar = document.querySelector('.strength-bar-fill');
  const strengthText = document.querySelector('.strength-text');
  const strengthContainer = document.querySelector('.strength-bar');
  
  if (strengthBar && strengthText && strengthContainer) {
    const widthPercent = Math.max((validation.score / 5) * 100, 10);
    strengthBar.style.width = `${widthPercent}%`;
    
    // Remove existing strength classes
    strengthContainer.classList.remove('strength-weak', 'strength-medium', 'strength-strong');
    
    // Add appropriate strength class
    strengthContainer.classList.add(`strength-${validation.strength}`);
    
    if (validation.strength === 'strong') {
      strengthText.textContent = 'Password Strength: Strong';
    } else if (validation.strength === 'medium') {
      strengthText.textContent = 'Password Strength: Medium';
    } else if (validation.strength === 'weak') {
      strengthText.textContent = 'Password Strength: Weak';
    } else {
      strengthText.textContent = 'Password Strength: Enter password';
    }
  }
}

function validatePasswordMatch() {
  const password = document.getElementById('new-password')?.value || '';
  const confirmPassword = document.getElementById('confirm-password')?.value || '';
  
  if (!confirmPassword) {
    return { valid: false, message: 'Please confirm your password' };
  }
  
  const validation = {
    valid: password === confirmPassword && password.length > 0,
    message: password === confirmPassword ? 'Passwords match' : 'Passwords do not match'
  };
  
  showFieldValidation('confirm-password', validation);
  return validation;
}

function updateSubmitButtonState() {
  const submitBtn = document.getElementById('create-user-btn');
  if (!submitBtn) return;
  
  const requiredFields = [
    { id: 'new-username', validator: validateUsername },
    { id: 'new-email', validator: validateEmail },
    { id: 'new-role', validator: (v) => validateRequired(v, 'Role') },
    { id: 'new-department', validator: (v) => validateRequired(v, 'Department') },
    { id: 'new-password', validator: validatePassword }
  ];
  
  let allValid = true;
  
  for (const field of requiredFields) {
    const element = document.getElementById(field.id);
    if (element) {
      const validation = field.validator(element.value);
      if (!validation.valid) {
        allValid = false;
        break;
      }
    }
  }
  
  // Check password match
  const passwordMatch = validatePasswordMatch();
  if (!passwordMatch.valid) {
    allValid = false;
  }
  
  submitBtn.disabled = !allValid;
}

// Add real-time validation
document.addEventListener('DOMContentLoaded', function() {
  // Show/hide add user form
  const addUserBtn = document.getElementById('add-user-btn');
  const addUserContainer = document.getElementById('add-user-form-container');
  const closeFormBtn = document.getElementById('close-add-user-form');
  const cancelBtn = document.getElementById('cancel-add-user');
  
  if (addUserBtn && addUserContainer) {
    addUserBtn.addEventListener('click', function() {
      addUserContainer.style.display = 'block';
      addUserContainer.scrollIntoView({ behavior: 'smooth' });
    });
  }
  
  function hideAddUserForm() {
    if (addUserContainer) {
      addUserContainer.style.display = 'none';
      // Reset form
      const form = document.getElementById('add-user-form');
      if (form) form.reset();
      // Clear validations
      document.querySelectorAll('.validation-error, .validation-success').forEach(el => {
        el.style.display = 'none';
      });
      // Reset password strength
      const strengthBar = document.querySelector('.strength-bar-fill');
      const strengthText = document.querySelector('.strength-text');
      if (strengthBar) strengthBar.style.width = '0%';
      if (strengthText) strengthText.textContent = 'Password Strength: Enter password';
    }
  }
  
  if (closeFormBtn) closeFormBtn.addEventListener('click', hideAddUserForm);
  if (cancelBtn) cancelBtn.addEventListener('click', hideAddUserForm);
  
  // Username validation
  const usernameField = document.getElementById('new-username');
  if (usernameField) {
    usernameField.addEventListener('input', function() {
      const validation = validateUsername(this.value);
      showFieldValidation('new-username', validation);
    });
  }
  
  // Email validation
  const emailField = document.getElementById('new-email');
  if (emailField) {
    emailField.addEventListener('input', function() {
      const validation = validateEmail(this.value);
      showFieldValidation('new-email', validation);
    });
  }
  
  // Password validation
  const passwordField = document.getElementById('new-password');
  if (passwordField) {
    passwordField.addEventListener('input', function() {
      const validation = validatePassword(this.value);
      showFieldValidation('new-password', validation);
      updatePasswordStrength(this.value);
    });
  }
  
  // Confirm password validation
  const confirmPasswordField = document.getElementById('confirm-password');
  if (confirmPasswordField) {
    confirmPasswordField.addEventListener('input', function() {
      validatePasswordMatch();
    });
  }
  
  // Role and department change actions
  const roleField = document.getElementById('new-role');
  const departmentField = document.getElementById('new-department');
  if (roleField && departmentField) {
    roleField.addEventListener('change', function() {
      // Auto-select department based on role (example logic)
      if (this.value === 'Administrator') {
        departmentField.value = 'Management';
      } else {
        departmentField.value = '';
      }
      updateSubmitButtonState();
    });
    
    departmentField.addEventListener('change', function() {
      // Auto-select role based on department (example logic)
      if (this.value === 'Management') {
        roleField.value = 'Administrator';
      } else {
        roleField.value = '';
      }
      updateSubmitButtonState();
    });
  }
});

  </script>
</body>
</html>