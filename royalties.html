<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Mining Royalties Manager - A comprehensive solution for managing mining royalties">
  <title>Mining Royalties Manager</title>
  
  <!-- Favicon -->
  <link rel="shortcut icon" href="favicon.svg" type="image/svg+xml">
  
  <!-- External Dependencies -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <!-- ==== CORE MANAGEMENT MODULES - LOAD FIRST ==== -->
  <!-- Core management modules must load before everything else -->
  <script src="js/theme-manager.js?v=1.0.0"></script>
  <script src="js/modules/NavigationManager.js?v=1.0.0"></script>
  <script src="js/modules/UserManager.js?v=1.0.0"></script>
  <script src="js/modules/IconManager.js?v=1.0.0"></script>
  
  <!-- ==== ENHANCED UX AND PERFORMANCE OPTIMIZATIONS ==== -->
  <!-- Performance optimizer - Load early for maximum benefit -->
  <script src="js/performance-optimizer.js?v=1.0.0"></script>
  
  <!-- Enhanced UX optimizations -->
  <script src="js/enhanced-ux-optimizations.js?v=1.0.0"></script>
  
  <!-- Enhanced mobile navigation -->
  <script src="js/enhanced-mobile-navigation.js?v=1.0.0"></script>
  
  <!-- Advanced accessibility features -->
  <script src="js/accessibility-enhancer.js?v=1.0.0"></script>
  
  <!-- ==== MODERN UI/UX ENHANCEMENT SYSTEM ==== -->
  <!-- Load modern UI system early for optimal integration -->
  <script src="js/modern-theme-manager.js?v=1.0.0"></script>
  <script src="js/modern-ui-orchestrator.js?v=1.0.0"></script>
  <script src="js/modern-semantic-search.js?v=1.0.0"></script>
  <script src="js/modern-ui-integration.js?v=1.0.0"></script>
  
  <!-- ==== UNIFIED SYSTEM STACK - PROPERLY ORDERED ==== -->
  
  <!-- 1. First load the core notification system -->
  <script src="js/enhanced-notification-system.js?v=2.0.2"></script>
  
  <!-- Notification System Verification Script -->
  <script>
    (function() {
      console.log('=== NOTIFICATION SYSTEM VERIFICATION ===');
      
      // Ensure notification system is available
      function verifyNotificationSystem() {
        if (typeof window.NotificationSystem !== 'undefined') {
          console.log('✅ NotificationSystem loaded successfully');
          
          // Ensure notificationManager is set with proper methods
          if (!window.notificationManager) {
            window.notificationManager = window.NotificationSystem;
            console.log('✅ notificationManager reference created');
          }
          
          // Ensure show method exists and works
          if (typeof window.notificationManager.show !== 'function') {
            console.warn('⚠️ notificationManager.show method not found, creating fallback');
            window.notificationManager.show = function(message, type = 'info', options = {}) {
              console.log(`Notification (${type}): ${message}`, options);
              
              // Try to use the actual notification system if available
              if (window.NotificationSystem && typeof window.NotificationSystem.show === 'function') {
                return window.NotificationSystem.show(message, type, options);
              }
              
              // Fallback to browser alert for critical messages
              if (type === 'error' || type === 'critical') {
                alert(`${type.toUpperCase()}: ${message}`);
              }
              
              return true;
            };
          }
          
          // Test basic functionality
          if (typeof window.notificationManager.init === 'function') {
            try {
              window.notificationManager.init();
              console.log('✅ NotificationSystem initialized successfully');
            } catch (error) {
              console.warn('⚠️ NotificationSystem initialization warning:', error);
            }
          }
          
          // Test show method
          try {
            window.notificationManager.show('Notification system ready', 'success', { duration: 2000 });
            console.log('✅ NotificationSystem show method working');
          } catch (error) {
            console.warn('⚠️ NotificationSystem show method issue:', error);
          }
          
          console.log('✅ Notification system verification complete');
        } else {
          console.error('❌ NotificationSystem not found after loading');
          setTimeout(verifyNotificationSystem, 100); // Retry
        }
      }
      
      // Run verification after a short delay
      setTimeout(verifyNotificationSystem, 50);
      
      console.log('=== NOTIFICATION SYSTEM VERIFICATION: SETUP COMPLETE ===');
    })();
  </script>
  
  <!-- 2. Then the core chart system -->
  <script src="js/unified-chart-solution.js?v=1.0.4"></script>
  
  <!-- 3. Component loader for dynamic content -->
  <script src="js/unified-component-loader.js?v=1.0.4"></script>
  
  <!-- Base chart manager instantiation - keep for compatibility -->
  <script>
    (function() {
      console.log('=== CHART MANAGER BASE SETUP ===');
      
      // Ensure chart manager exists with required methods
      if (!window.chartManager) {
        window.chartManager = {
          charts: new Map(),
          isChartJsLoaded: typeof Chart !== 'undefined'
        };
      }
      
      // Note: Chart initialization will be handled by individual components
      // when they are loaded, not globally here to prevent timing issues
      
      console.log('=== CHART MANAGER BASE SETUP: COMPLETE ===');
    })();
  </script>
  
  <!-- Modern CSS Design System -->
  <link rel="stylesheet" href="css/base.css">
  <link rel="stylesheet" href="css/variables.css">
  
  <!-- Modern CSS Files -->
  <link rel="stylesheet" href="css/modern-layout.css?v=2.0.0">
  <link rel="stylesheet" href="css/modern-components.css?v=2.0.0">
  <link rel="stylesheet" href="css/modern-data-visualization.css?v=2.0.0">
  <link rel="stylesheet" href="css/modern-ui-enhancements.css?v=2.0.0">
  <link rel="stylesheet" href="css/modern-semantic-search.css?v=2.0.0">
  
  <!-- Dark Mode CSS (loaded last for proper cascade) -->
  <link rel="stylesheet" href="css/modern-dark-mode.css" media="(prefers-color-scheme: dark)">
  <link rel="stylesheet" href="css/modern-dark-mode.css" id="dark-mode-styles" disabled>
  
  <!-- WIDTH DEBUGGING AND FORCE FIX -->
  <script>
    // Force Contract Management width to match User Management after DOM loads
    document.addEventListener('DOMContentLoaded', function() {
      function forceContractManagementWidth() {
        const userMgmt = document.getElementById('user-management');
        const contractMgmt = document.getElementById('contract-management');
        
        if (userMgmt && contractMgmt) {
          console.log('=== WIDTH DEBUGGING ===');
          console.log('User Management computed width:', window.getComputedStyle(userMgmt).width);
          console.log('Contract Management computed width:', window.getComputedStyle(contractMgmt).width);
          console.log('User Management client width:', userMgmt.clientWidth);
          console.log('Contract Management client width:', contractMgmt.clientWidth);
          
          // Force same width
          contractMgmt.style.cssText = `
            width: ${userMgmt.clientWidth}px !important;
            max-width: ${userMgmt.clientWidth}px !important;
            padding: ${window.getComputedStyle(userMgmt).padding} !important;
            margin: ${window.getComputedStyle(userMgmt).margin} !important;
            box-sizing: border-box !important;
          `;
          
          console.log('After force - Contract Management width:', window.getComputedStyle(contractMgmt).width);
        }
      }
      
      // Run initially
      setTimeout(forceContractManagementWidth, 1000);
      
      // Run whenever navigation occurs
      document.addEventListener('click', function(e) {
        if (e.target.closest('[data-section="contract-management"]')) {
          setTimeout(forceContractManagementWidth, 500);
        }
      });
    });
  </script>
  
  <!-- Critical CSS for immediate loading -->
  <style>
    /* Critical CSS - Loading and basic layout */
    :root {
      --primary-color: #0066cc;
      --gradient-primary: linear-gradient(135deg, #0066cc 0%, #004499 100%);
      --text-inverse: #ffffff;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      --surface-glass: rgba(255, 255, 255, 0.1);
      --backdrop-blur: blur(20px);
    }

    [data-theme="dark"] {
      --primary-color: #3b82f6;
      --gradient-primary: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
      --surface-glass: rgba(0, 0, 0, 0.2);
    }

    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--gradient-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      backdrop-filter: var(--backdrop-blur);
    }

    .loading-content {
      text-align: center;
      color: var(--text-inverse);
      background: var(--surface-glass);
      backdrop-filter: var(--backdrop-blur);
      padding: 2rem;
      border-radius: 1rem;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1.5rem;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Theme toggle styles */
    .theme-toggle {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 10001;
      background: var(--surface-glass);
      backdrop-filter: var(--backdrop-blur);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      width: 3rem;
      height: 3rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: var(--transition);
      color: var(--text-inverse);
      font-size: 1.25rem;
    }

    .theme-toggle:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: scale(1.1);
    }

    /* Hide containers by default */
    #login-section {
      display: none;
    }

    #app-container {
      display: none;
    }

    /* Fix for notification styling */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 1rem 1.5rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      z-index: 10000;
      min-width: 300px;
      max-width: 500px;
      animation: slideInFromRight 0.3s ease-out;
    }

    .notification-success {
      border-left: 4px solid #38a169;
      background: linear-gradient(135deg, rgba(56, 161, 105, 0.05) 0%, white 100%);
    }

    .notification-error {
      border-left: 4px solid #e53e3e;
      background: linear-gradient(135deg, rgba(229, 62, 62, 0.05) 0%, white 100%);
    }

    .notification-info {
      border-left: 4px solid #3182ce;
      background: linear-gradient(135deg, rgba(49, 130, 206, 0.05) 0%, white 100%);
    }

    .notification-warning {
      border-left: 4px solid #d69e2e;
      background: linear-gradient(135deg, rgba(214, 158, 46, 0.05) 0%, white 100%);
    }

    .notification-content {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .notification-close {
      position: absolute;
      top: 0.5rem;
      right: 0.75rem;
      background: none;
      border: none;
      font-size: 1.25rem;
      cursor: pointer;
      color: #666;
      padding: 0.25rem;
    }

    .notification-close:hover {
      color: #333;
    }

    @keyframes slideInFromRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* Skip Links for Accessibility */
    .skip-links {
      position: absolute;
      top: -40px;
      left: 6px;
      z-index: 10000;
    }

    .skip-link {
      position: absolute;
      background: var(--primary-color);
      color: white;
      padding: 8px 12px;
      text-decoration: none;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
      top: -40px;
      opacity: 0;
    }

    .skip-link:focus {
      top: 6px;
      opacity: 1;
      outline: 2px solid #ffffff;
      outline-offset: 2px;
    }

    .skip-link:nth-child(2) { left: 140px; }
    .skip-link:nth-child(3) { left: 280px; }
  </style>
</head>
<body>  <!-- Theme Toggle -->
  <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme" title="Toggle between light and dark theme">
    <i class="fas fa-moon" id="theme-icon"></i>
  </button>

  <!-- Skip Links for Accessibility -->
  <div class="skip-links">
    <a href="#main-content" class="skip-link">Skip to main content</a>
    <a href="#sidebar" class="skip-link">Skip to navigation</a>
    <a href="#footer" class="skip-link">Skip to footer</a>
  </div>

  <!-- Loading Screen -->
  <div class="loading-screen" id="loading-screen">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <p>Loading Mining Royalties Manager...</p>
      <div id="loading-protocol-message" style="display: none; margin-top: 15px; padding: 10px; border-radius: 5px; background: rgba(0,0,0,0.2); font-size: 14px; max-width: 400px;">
        <strong>Loading in file:// protocol mode</strong><br>
        Limited functionality available.<br>
        For best results, use a web server instead.
      </div>
      <script>
        // Add file:// protocol message if needed
        if (window.location.protocol === 'file:') {
          document.getElementById('loading-protocol-message').style.display = 'block';
        }
      </script>
    </div>
  </div>

  <!-- Login Section -->
  <section class="login-section" id="login-section">
    <div class="login-container">
      <div class="login-header">
        <div class="login-logo">MR</div>
        <h2>Mining Royalties Manager</h2>
        <p>Secure access to your royalty management system</p>
      </div>
      <form class="login-form" id="login-form">
        <div class="input-group">
          <i class="fas fa-user"></i>
          <input type="text" id="username" name="username" placeholder="Username" required>
        </div>
        <div class="input-group">
          <i class="fas fa-lock"></i>
          <input type="password" id="password" name="password" placeholder="Password" required>
          <button type="button" class="password-toggle">
            <i class="fas fa-eye"></i>
          </button>
        </div>
        <button type="submit" class="btn btn-primary btn-large">Sign In</button>
      </form>
      <div class="login-footer">
        <p>Demo credentials: <strong>admin/admin123</strong> | <strong>editor/editor123</strong> | <strong>viewer/viewer123</strong></p>
      </div>
    </div>
  </section>

  <!-- Main App Container -->
  <div class="app-container modern-layout" id="app-container">
    <!-- Sidebar -->
    <aside class="sidebar modern-sidebar glass-morphism" id="sidebar" role="navigation" aria-label="Main navigation">
      <!-- Sidebar content will be loaded dynamically -->
    </aside>

    <!-- Main Content -->
    <main class="main-content modern-main-content" id="main-content" role="main">
      <!-- Global Semantic Search -->
      <div class="semantic-search-container" style="margin-bottom: 2rem;"></div>
      
      <!-- Dashboard Section -->
      <section id="dashboard" class="content-section">
        <!-- Dashboard content will be loaded dynamically -->
      </section>

      <!-- User Management Section -->
      <section id="user-management" class="content-section" style="display: none;">
        <!-- User management content will be loaded dynamically -->
      </section>

      <!-- Royalty Records Section -->
      <section id="royalty-records" class="content-section" style="display: none;">
        <!-- Royalty records content will be loaded dynamically -->
      </section>

      <!-- Contract Management Section -->
      <section id="contract-management" class="content-section" style="display: none;">
        <!-- Contract management content will be loaded dynamically -->
      </section>

      <!-- Reporting & Analytics Section -->
      <section id="reporting-analytics" class="content-section" style="display: none;">
        <!-- Reporting analytics content will be loaded dynamically from components/reporting-analytics.html -->
      </section>

      <!-- Communication Section -->
      <section id="communication" class="content-section" style="display: none;">
        <!-- Communication content will be loaded dynamically -->
      </section>

      <!-- Notifications Section -->
      <section id="notifications" class="content-section" style="display: none;">
        <div id="notifications-content"></div>
      </section>

      <!-- Compliance Section -->
      <section id="compliance" class="content-section" style="display: none;">
        <!-- Compliance content will be loaded dynamically -->
      </section>

      <!-- Regulatory Management Section -->
      <section id="regulatory-management" class="content-section" style="display: none;">
        <!-- Regulatory management content will be loaded dynamically -->
      </section>

      <!-- Profile Section -->
      <section id="profile" class="content-section" style="display: none;">
        <!-- Profile content will be loaded dynamically -->
      </section>
    </main>
  </div>  <!-- Scripts -->
  <!-- Load core modules and scripts in correct order -->
  <script src="js/utils.js?v=20250627" type="text/javascript"></script>
  <script src="js/compliance-functions.js?v=1.0.0" type="text/javascript"></script>
  
  <!-- Note: unified-component-loader.js is loaded in the head section and replaces module-loader.js -->
  <script src="app.js?v=20250628g" type="text/javascript"></script>
  <!-- Removed deleted scripts: component-initializer.js, sidebar-manager.js, startup.js, dashboard.js -->
  
  <!-- Application Initialization Script -->
  <script>
    // Initialize the application once all scripts are loaded
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM Content Loaded - Initializing Application');
      
      // Initialize the main application
      if (typeof RoyaltiesApp !== 'undefined') {
        try {
          console.log('Creating and initializing RoyaltiesApp...');
          window.royaltiesApp = new RoyaltiesApp();
          window.royaltiesApp.initialize();
          console.log('Application initialized successfully');
        } catch (error) {
          console.error('Failed to initialize application:', error);
        }
      } else {
        console.error('RoyaltiesApp class not found!');
      }
    });
  </script>
  <!-- Service worker ensures all dependencies are cached for offline use -->
  <!-- Service Worker Registration -->
  <script>
      // Display protocol information for debugging
      console.log("Current protocol: " + window.location.protocol);
      console.log("Current origin: " + window.location.origin);

      // Enhanced error handling for service worker message channel errors
      window.addEventListener('unhandledrejection', function(event) {
        // Check for service worker message channel errors (multiple patterns)
        if (event.reason && 
            event.reason.message && 
            (event.reason.message.includes('message channel closed') || 
             event.reason.message.includes('ServiceWorker') || 
             event.reason.message.includes('service worker'))) {
          console.debug('Service Worker message suppressed:', event.reason.message);
          event.preventDefault(); // Prevents the default error handling
          event.stopPropagation(); // Stops propagation to other handlers
          return false; // Explicitly return false
        }
      });

      // Additional error listener for console cleanup
      window.addEventListener('error', function(event) {
        if (event.filename && event.filename.includes('sw.js')) {
          console.debug('Service Worker error suppressed:', event.message);
          event.preventDefault();
          event.stopPropagation();
          return false;
        }
      });

      if ('serviceWorker' in navigator) {
          if (window.location.protocol !== 'file:') {
              // Only register the service worker if we're not on file:// protocol
              navigator.serviceWorker.register('sw.js?v=3.5')
                  .then(registration => {
                      console.log('SW registered successfully: ', registration);
                      
                      // Handle updates
                      if (registration.waiting) {
                          console.log('SW: New version waiting, activating...');
                          registration.waiting.postMessage({type: 'SKIP_WAITING'});
                      }
                      
                      // Listen for new SW installing
                      
                      // Suppress any message channel errors
                      const originalPostMessage = navigator.serviceWorker.controller?.postMessage;
                      if (originalPostMessage) {
                          navigator.serviceWorker.controller.postMessage = function() {
                              try {
                                  return originalPostMessage.apply(this, arguments);
                              } catch (err) {
                                  console.debug('Suppressed SW postMessage error');
                                  return Promise.resolve(); // Return resolved promise
                              }
                          };
                      }
                      registration.addEventListener('updatefound', () => {
                          const newWorker = registration.installing;
                          console.log('SW: New version installing');
                          
                          // Add reliable waiting detection
                          newWorker.addEventListener('statechange', () => {
                              if (newWorker.state === 'installed') {
                                  console.log('SW: New version installed and waiting');
                              }
                          });
                      });
                  })                  .catch(registrationError => {
                      console.error('SW registration failed: ', registrationError);
                      
                      // More detailed error information
                      console.log('Registration error details:');
                      console.log('- Error name: ' + registrationError.name);
                      console.log('- Error message: ' + registrationError.message);
                  });
              
              // Listen for controlled page change indicating a new service worker is active
              navigator.serviceWorker.addEventListener('controllerchange', () => {
                  console.log('SW: New service worker controlling page');
              });
          } else {
              console.warn('Service Worker cannot be registered when loading from file:// protocol. Please use a web server instead.');
              console.log('Try using:');
              console.log('1. VS Code Live Server extension');
              console.log('2. Python: python -m http.server');
              console.log('3. Node: npx http-server');
          }
      } else {          console.warn('Service Worker is not supported in this browser');
      }
  </script>
  
  <!-- File Protocol Detection and Warning Banner -->
  <script>
      // Check if running from file:// protocol and show appropriate warning
      document.addEventListener('DOMContentLoaded', function() {
          if (window.location.protocol === 'file:') {
              // Create the banner if it doesn't exist
              let banner = document.getElementById('file-protocol-banner');
              if (!banner) {
                  banner = document.createElement('div');
                  banner.id = 'file-protocol-banner';
                  banner.style.cssText = 'background: #f8d7da; color: #721c24; padding: 10px 15px; font-size: 14px; text-align: center; border-bottom: 1px solid #f5c6cb; position: fixed; top: 0; left: 0; right: 0; z-index: 10000;';
                  
                  banner.innerHTML = `
                      <strong>Limited Functionality Mode:</strong> You are running the application from a local file. 
                      Some features will be restricted. For full functionality, please serve the application through a web server.
                      <button onclick="this.parentElement.style.display='none';" 
                              style="background: none; border: none; cursor: pointer; font-size: 16px; float: right; margin-top: -2px;">
                          &times;
                      </button>
                  `;
                  
                  document.body.insertBefore(banner, document.body.firstChild);
              } else {
                  banner.style.display = 'block';
              }
              
              // Log additional guidance for users
              console.info('%c Running in FILE:// PROTOCOL MODE - Limited Functionality ', 'background: #721c24; color: white; padding: 5px;');
              console.info('Some features will not work due to browser security restrictions when loading from file://');
              console.info('For full functionality, please use a web server such as:');
              console.info('1. VS Code Live Server extension');
              console.info('2. Python: python -m http.server');
              console.info('3. Node: npx http-server');
          }
      });
  </script>

  <!-- Force chart method registration -->
  <script>
    // This script forces the proper registration of chart methods
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Forcing chart methods registration...');
      
      setTimeout(function registerChartMethods() {
        // Check if chartManager exists
        if (!window.chartManager) {
          console.error('Chart manager not found! Creating minimal instance...');
          window.chartManager = {
            charts: new Map(),
            isChartJsLoaded: typeof Chart !== 'undefined'
          };
        }
        
        // Log available methods
        console.log('Chart manager methods before patch:');
        const methods = Object.getOwnPropertyNames(window.chartManager.__proto__);
        console.log(methods);
        
        // Force create the missing method if needed
        if (!methods.includes('createProductionChart')) {
          console.log('Explicitly adding createProductionChart method...');
          
          window.chartManager.__proto__.createProductionChart = function(canvasId, data) {
            console.log(`PATCHED: Creating production chart on canvas '${canvasId}'`);
            
            // Try to use the entity chart method if available
            if (typeof this.createEntityChart === 'function') {
              return this.createEntityChart(canvasId, data);
            }
            
            // Otherwise create a basic chart
            let canvas = document.getElementById(canvasId);
            if (!canvas) {
              console.error(`Canvas with id '${canvasId}' not found for production chart`);
              return null;
            }
            
            const chartData = {
              labels: ['Entity A', 'Entity B', 'Entity C', 'Entity D', 'Entity E'],
              datasets: [{
                data: [300, 150, 100, 75, 50],
                backgroundColor: ['#1a365d', '#2d5282', '#3b6eb6', '#598ade', '#84abeb']
              }]
            };
            
            return this.create(canvasId, {
              type: 'doughnut',
              data: chartData
            });
          };
          
          console.log('Chart manager methods after patch:');
          console.log(Object.getOwnPropertyNames(window.chartManager.__proto__));
        }
      }, 1000);
    });
  </script>

  <!-- Dashboard Initialization Script -->
  <script>
    // This script ensures that the dashboard content loads properly
    document.addEventListener('DOMContentLoaded', function() {
      // Wait for app initialization
      setTimeout(function checkDashboard() {
        const dashboard = document.getElementById('dashboard');
        if (dashboard && dashboard.innerHTML.trim() === '') {
          console.log('Dashboard content empty, attempting to initialize...');
          // Try to trigger component loading if available
          if (window.unifiedComponentLoader) {
            console.log('Loading dashboard component via unifiedComponentLoader');
            window.unifiedComponentLoader.loadComponent('dashboard', dashboard)
              .then(result => {
                console.log('Dashboard component load result:', result.success ? 'success' : 'failed');
              })
              .catch(err => {
                console.warn('Error loading dashboard component:', err);
              });
          } else if (window.moduleLoader && window.moduleLoader.loadComponent) {
            console.log('Loading dashboard component via moduleLoader (fallback)');
            window.moduleLoader.loadComponent('dashboard', dashboard)
              .then(result => {
                console.log('Dashboard component load result:', result.success ? 'success' : 'failed');
              })
              .catch(err => {
                console.warn('Error loading dashboard component:', err);
              });
          } else if (window.app && window.app.loadSectionContent) {
            console.log('Loading dashboard content via app.loadSectionContent');
            window.app.loadSectionContent('dashboard');
          } else if (window.royaltiesApp && window.royaltiesApp.loadSectionContent) {
            console.log('Loading dashboard content via royaltiesApp.loadSectionContent');
            window.royaltiesApp.loadSectionContent('dashboard');
          }
        }
      }, 3000); // Check after 3 seconds to ensure everything has had time to load
    });
  </script>

  <!-- Demo functionality - add sample notification triggers -->
  <script>
    setTimeout(() => {
        if (window.NotificationSystem) {
            // Add demo button to trigger various notifications
            const demoButton = document.createElement('button');
            demoButton.innerHTML = '<i class="fas fa-bell"></i> Demo Notifications';
            demoButton.className = 'btn btn-outline-info demo-notifications-btn';
            demoButton.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                z-index: 9998;
                border-radius: 25px;
                padding: 10px 20px;
                font-size: 14px;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
                backdrop-filter: blur(10px);
                background: rgba(255, 255, 255, 0.9);
                border: 1px solid rgba(59, 130, 246, 0.3);
                color: #3b82f6;
                cursor: pointer;
                transition: all 0.3s ease;
            `;
            
            let demoCount = 0;
            const demoNotifications = [
                {
                    type: 'success',
                    title: 'Payment Processed',
                    message: 'Royalty payment of E75,000 received from Ngwenya Iron Ore Mine',
                    options: { persistent: true, category: 'payment', priority: 'normal' }
                },
                {
                    type: 'warning',
                    title: 'Contract Expiring Soon',
                    message: 'Mining contract MC-2024-008 will expire in 14 days',
                    options: { persistent: true, category: 'contract', priority: 'high' }
                },
                {
                    type: 'error',
                    title: 'Critical: Compliance Issue',
                    message: 'Environmental report overdue by 7 days for Lobamba Quarry',
                    options: { persistent: true, category: 'compliance', priority: 'urgent' }
                },
                {
                    type: 'info',
                    title: 'System Maintenance',
                    message: 'Scheduled backup completed successfully at 2:30 AM',
                    options: { persistent: true, category: 'system', priority: 'normal' }
                },
                {
                    type: 'success',
                    title: 'Document Approved',
                    message: 'Mining permit renewal for Sidvokodvo has been approved',
                    options: { persistent: true, category: 'compliance', priority: 'normal' }
                },
                {
                    type: 'warning',
                    title: 'Payment Reminder',
                    message: 'ROY-2024-009 payment due in 3 days - Amount: E125,000',
                    options: { persistent: true, category: 'payment', priority: 'high' }
                }
            ];
            
            demoButton.addEventListener('click', () => {
                const notification = demoNotifications[demoCount % demoNotifications.length];
                window.NotificationSystem.show(
                    notification.type,
                    notification.title,
                    notification.message,
                    notification.options
                );
                demoCount++;
                
                // Show success feedback
                demoButton.innerHTML = '<i class="fas fa-check"></i> Sent!';
                demoButton.style.background = 'rgba(16, 185, 129, 0.1)';
                demoButton.style.borderColor = 'rgba(16, 185, 129, 0.3)';
                demoButton.style.color = '#10b981';
                
                setTimeout(() => {
                    demoButton.innerHTML = '<i class="fas fa-bell"></i> Demo Notifications';
                    demoButton.style.background = 'rgba(255, 255, 255, 0.9)';
                    demoButton.style.borderColor = 'rgba(59, 130, 246, 0.3)';
                    demoButton.style.color = '#3b82f6';
                }, 1000);
            });
            
            demoButton.addEventListener('mouseenter', () => {
                demoButton.style.transform = 'translateY(-2px)';
                demoButton.style.boxShadow = '0 6px 25px rgba(0, 0, 0, 0.15)';
            });
            
            demoButton.addEventListener('mouseleave', () => {
                demoButton.style.transform = 'translateY(0)';
                demoButton.style.boxShadow = '0 4px 20px rgba(0, 0, 0, 0.1)';
            });
            
            document.body.appendChild(demoButton);
            
            console.log('Enhanced Notification System: Demo button added! Click to test notifications.');
        }
    }, 1000);

    // Add notification sound toggle button
    setTimeout(() => {
        if (window.NotificationSystem) {
            const soundToggle = document.createElement('button');
            soundToggle.innerHTML = '<i class="fas fa-volume-up"></i>';
            soundToggle.className = 'btn btn-outline-secondary sound-toggle-btn';
            soundToggle.style.cssText = `
                position: fixed;
                bottom: 80px;
                right: 20px;
                z-index: 9998;
                border-radius: 50%;
                width: 50px;
                height: 50px;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
                backdrop-filter: blur(10px);
                background: rgba(255, 255, 255, 0.9);
                border: 1px solid rgba(107, 114, 128, 0.3);
                color: #6b7280;
                cursor: pointer;
                transition: all 0.3s ease;
            `;
            
            soundToggle.addEventListener('click', () => {
                const soundEnabled = window.NotificationSystem.toggleSound();
                soundToggle.innerHTML = soundEnabled ? 
                    '<i class="fas fa-volume-up"></i>' : 
                    '<i class="fas fa-volume-mute"></i>';
                soundToggle.style.color = soundEnabled ? '#6b7280' : '#ef4444';
                soundToggle.style.borderColor = soundEnabled ? 'rgba(107, 114, 128, 0.3)' : 'rgba(239, 68, 68, 0.3)';
                
                // Show feedback
                window.NotificationSystem.info(
                    'Sound Settings',
                    `Notification sounds ${soundEnabled ? 'enabled' : 'disabled'}`,
                    { autoHide: true, persistent: false }
                );
            });
            
            document.body.appendChild(soundToggle);
        }
    }, 1000);

    // Enhanced: Load notifications center UI when Notifications section is shown
      function loadNotificationsSection() {
        const notificationsSection = document.getElementById('notifications');
        const notificationsContent = document.getElementById('notifications-content');
        if (notificationsSection && notificationsContent && !notificationsContent.dataset.loaded) {
          fetch('components/notifications.html')
            .then(response => response.text())
            .then(html => {
              notificationsContent.innerHTML = html;
              notificationsContent.dataset.loaded = 'true';
              // Re-initialize notification center logic if needed
              if (window.EnhancedNotificationCenter && typeof window.EnhancedNotificationCenter.init === 'function') {
                window.EnhancedNotificationCenter.init();
              }
              // Also initialize window.notificationCenter if present
              if (window.notificationCenter && typeof window.notificationCenter.init === 'function') {
                window.notificationCenter.init();
              }
              // If notificationCenter is a class, instantiate if not already
              if (typeof window.EnhancedNotificationCenter === 'function' && !window.notificationCenter) {
                window.notificationCenter = new window.EnhancedNotificationCenter();
              }
            });
        }
      }
      // Listen for section navigation
      document.addEventListener('sectionChange', function(e) {
        if (e.detail && e.detail.section === 'notifications') {
          loadNotificationsSection();
        }
      });
      // If notifications section is already visible on load, load it
      if (document.getElementById('notifications')?.style.display !== 'none') {
        loadNotificationsSection();
      }
  </script>

  <!-- Theme Toggle Script -->
  <script>
    (function() {
      // Theme management
      const THEME_KEY = 'royalties-theme';
      const themeToggle = document.getElementById('theme-toggle');
      const themeIcon = document.getElementById('theme-icon');
      const darkModeStyles = document.getElementById('dark-mode-styles');
      
      // Get saved theme or default to system preference
      function getCurrentTheme() {
        const savedTheme = localStorage.getItem(THEME_KEY);
        if (savedTheme) return savedTheme;
        
        return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      }
      
      // Apply theme
      function applyTheme(theme) {
        const html = document.documentElement;
        
        if (theme === 'dark') {
          html.setAttribute('data-theme', 'dark');
          darkModeStyles.disabled = false;
          themeIcon.className = 'fas fa-sun';
          themeToggle.setAttribute('aria-label', 'Switch to light theme');
          themeToggle.setAttribute('title', 'Switch to light theme');
        } else {
          html.removeAttribute('data-theme');
          darkModeStyles.disabled = true;
          themeIcon.className = 'fas fa-moon';
          themeToggle.setAttribute('aria-label', 'Switch to dark theme');
          themeToggle.setAttribute('title', 'Switch to dark theme');
        }
        
        localStorage.setItem(THEME_KEY, theme);
        
        // Dispatch custom event for other components
        window.dispatchEvent(new CustomEvent('themeChanged', { 
          detail: { theme } 
        }));
      }
      
      // Toggle theme
      function toggleTheme() {
        const currentTheme = getCurrentTheme();
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        applyTheme(newTheme);
        
        // Add animation feedback
        themeToggle.style.transform = 'scale(0.9) rotate(180deg)';
        setTimeout(() => {
          themeToggle.style.transform = '';
        }, 200);
      }
      
      // Initialize theme on page load
      function initializeTheme() {
        const theme = getCurrentTheme();
        applyTheme(theme);
      }
      
      // Event listeners
      if (themeToggle) {
        themeToggle.addEventListener('click', toggleTheme);
        
        // Keyboard support
        themeToggle.addEventListener('keydown', function(e) {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            toggleTheme();
          }
        });
      }
      
      // Listen for system theme changes
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
        // Only auto-switch if user hasn't manually set a preference
        if (!localStorage.getItem(THEME_KEY)) {
          applyTheme(e.matches ? 'dark' : 'light');
        }
      });
      
      // Initialize immediately
      initializeTheme();
      
      // Also initialize when DOM is ready (in case this runs before theme toggle is in DOM)
      document.addEventListener('DOMContentLoaded', initializeTheme);
    })();
  </script>

  <!-- Development Testing Script (remove in production) -->
  <script src="js/test-modernization.js?v=1.0.0"></script>

  <!-- Main Application Script - Load Last -->  
  <!-- Modern Styles Enhancement Script -->
  <script>
    (function() {
      console.log('=== MODERN STYLES ENHANCEMENT ===');
      
      function enhanceModernStyles() {
        // Apply modern classes to key elements
        const appContainer = document.getElementById('app-container');
        if (appContainer) {
          appContainer.classList.add('modern-layout');
        }
        
        const sidebar = document.getElementById('sidebar');
        if (sidebar) {
          sidebar.classList.add('modern-sidebar', 'glass-morphism');
        }
        
        const mainContent = document.getElementById('main-content');
        if (mainContent) {
          mainContent.classList.add('modern-main-content');
        }
        
        // Apply modern styles to dynamically loaded content
        const cards = document.querySelectorAll('.card, .dashboard-card, .stats-card');
        cards.forEach(card => {
          card.classList.add('glass-card');
        });
        
        console.log('✅ Modern styles enhancement complete');
      }
      
      // Apply on DOM content loaded
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', enhanceModernStyles);
      } else {
        enhanceModernStyles();
      }
      
      // Also apply after a short delay for dynamic content
      setTimeout(enhanceModernStyles, 1000);
      
      console.log('=== MODERN STYLES ENHANCEMENT: SETUP COMPLETE ===');
    })();
  </script>
</body>
</html>