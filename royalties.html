<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mining Royalties Manager</title>
  <link rel="stylesheet" href="royalties.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <div class="loading-screen">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <h2>Mining Royalties Manager</h2>
      <p>Loading your workspace...</p>
    </div>
  </div>

  <div class="login-section">
    <div class="login-container">
      <div class="login-header">
        <div class="login-logo"><i class="fas fa-gem"></i></div>
        <h1>Mining Royalties Manager</h1>
        <p>Secure access to your royalty management system</p>
      </div>
      <form class="login-form" id="login-form">
        <div class="input-group">
          <i class="fas fa-user"></i>
          <input type="text" id="username" placeholder="Username" required>
          <div class="validation-error">Username is required</div>
        </div>
        <div class="input-group">
          <i class="fas fa-lock"></i>
          <input type="password" id="password" placeholder="Password" required>
          <button type="button" class="password-toggle"><i class="fas fa-eye"></i></button>
          <div class="validation-error">Password is required</div>
        </div>
        <button type="submit" class="btn-primary btn-large">
          <span class="btn-text"><i class="fas fa-sign-in-alt"></i> Sign In</span>
          <span class="btn-spinner spinner"></span>
        </button>
        <div class="error-message hidden"></div>
      </form>
      <div class="login-footer">
        <p>Demo Credentials: admin/admin123 or editor/editor123</p>
      </div>
    </div>
  </div>

  <div class="sidebar hidden" style="display: none;">
    <div class="sidebar-header">
      <div class="sidebar-logo"><i class="fas fa-gem"></i></div>
      <h2>Royalties Manager</h2>
      <button class="sidebar-close"><i class="fas fa-times"></i></button>
    </div>
    <div class="sidebar-content">
      <ul class="nav-menu">
        <li><a href="#dashboard" class="nav-link"><i class="fas fa-home"></i><span>Dashboard</span></a></li>
        <li><a href="#user-management" class="nav-link"><i class="fas fa-users"></i><span>User Management</span></a></li>
        <li><a href="#royalty-records" class="nav-link"><i class="fas fa-file-invoice-dollar"></i><span>Royalty Records</span></a></li>
        <li><a href="#contract-management" class="nav-link"><i class="fas fa-file-contract"></i><span>Contract Management</span></a></li>
        <li><a href="#audit-dashboard" class="nav-link"><i class="fas fa-search"></i><span>Audit Dashboard</span></a></li>
        <li><a href="#reporting-analytics" class="nav-link"><i class="fas fa-chart-bar"></i><span>Reporting & Analytics</span></a></li>
        <li><a href="#compliance" class="nav-link"><i class="fas fa-check-circle"></i><span>Compliance</span></a></li>
      </ul>
      <div class="nav-secondary">
        <ul class="nav-menu">
          <li><a href="#my-profile" class="nav-link"><i class="fas fa-user-circle"></i><span>My Profile</span></a></li>
          <li><a href="#notifications" class="nav-link"><i class="fas fa-bell"></i><span>Notifications</span><span class="notification-badge" id="notification-count">0</span></a></li>
        </ul>
      </div>
    </div>
    <div class="sidebar-footer">
      <button class="btn logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</button>
    </div>
  </div>

  <div class="app-container hidden" style="display: none;">
    <button class="mobile-menu-toggle"><span></span><span></span><span></span></button>
    <button class="theme-toggle"><i class="fas fa-moon"></i><i class="fas fa-sun"></i></button>

    <div class="main-content">
      <section id="dashboard" class="content-section">
        <div class="page-header">
          <div class="page-title">
            <h1>Dashboard</h1>
            <p>Welcome back, <span id="user-name">User</span></p>
          </div>
          <div class="page-actions">
            <div class="user-info">
              <span class="user-role" id="user-role">Admin</span>
              <div class="user-avatar"><i class="fas fa-user"></i></div>
            </div>
            <button class="notification-trigger"><i class="fas fa-bell"></i><span class="notification-badge" id="dashboard-notification-count">0</span></button>
          </div>
        </div>
        <div class="charts-grid">
          <div class="card">
            <div class="card-header">
              <h3>Total Royalties (YTD)</h3>
            </div>
            <div class="card-body">
              <p id="total-royalties">E0.00</p>
              <small id="royalty-trend">+0% from last year</small>
            </div>
          </div>
          <div class="card">
            <div class="card-header">
              <h3>Active Entities</h3>
            </div>
            <div class="card-body">
              <p id="active-entities">0</p>
              <small>No change</small>
            </div>
          </div>
          <div class="card">
            <div class="card-header">
              <h3>Compliance Rate</h3>
            </div>
            <div class="card-body">
              <p id="compliance-rate">0%</p>
            </div>
          </div>
          <div class="card">
            <div class="card-header">
              <h3>Pending Approvals</h3>
            </div>
            <div class="card-body">
              <p id="pending-approvals">0</p>
            </div>
          </div>
        </div>
        <div class="charts-grid">
          <div class="chart-card">
            <div class="chart-header">
              <h3>Royalty Trends</h3>
              <div class="chart-controls">
                <select class="chart-period" id="royalty-trends-period">
                  <option>Last 6 months</option>
                  <option>Last year</option>
                  <option>Last 2 years</option>
                </select>
              </div>
            </div>
            <div class="chart-container"><canvas id="royalty-trends-chart"></canvas></div>
          </div>
          <div class="chart-card">
            <div class="chart-header">
              <h3>Mineral Distribution</h3>
            </div>
            <div class="chart-container"><canvas id="mineral-distribution-chart"></canvas></div>
          </div>
        </div>
      </section>

      <section id="user-management" class="content-section">
        <div class="page-header">
          <div class="page-title">
            <h1>User Management</h1>
            <p>Manage users with role-based access control and security monitoring</p>
          </div>
          <div class="page-actions">
            <button class="btn btn-secondary" id="view-audit-log">
              <i class="fas fa-shield-alt"></i> View Audit Log
            </button>
            <button class="btn btn-secondary" id="export-user-report">
              <i class="fas fa-download"></i> Export Report
            </button>
            <button class="btn btn-primary" id="add-user-btn">
              <i class="fas fa-user-plus"></i> Add User
            </button>
          </div>
        </div>
        
        <!-- Security Overview Cards -->
        <div class="charts-grid">
          <div class="card">
            <div class="card-header">
              <h3><i class="fas fa-users"></i> Active Users</h3>
            </div>
            <div class="card-body">
              <p id="active-users-count">3</p>
              <small>Currently online</small>
            </div>
          </div>
          <div class="card">
            <div class="card-header">
              <h3><i class="fas fa-exclamation-triangle"></i> Failed Logins</h3>
            </div>
            <div class="card-body">
              <p id="failed-logins-count">0</p>
              <small>Last 24 hours</small>
            </div>
          </div>
          <div class="card">
            <div class="card-header">
              <h3><i class="fas fa-bell"></i> Security Alerts</h3>
            </div>
            <div class="card-body">
              <p id="last-security-alert">None</p>
              <small>All systems secure</small>
            </div>
          </div>
          <div class="card">
            <div class="card-header">
              <h3><i class="fas fa-lock"></i> Password Compliance</h3>
            </div>
            <div class="card-body">
              <p id="password-compliance">100%</p>
              <small>Meeting security standards</small>
            </div>
          </div>
        </div>

        <!-- Enhanced User Form with Security Features -->
        <div class="user-form-container" id="user-form-container" style="display: none;">
          <h4>Add New User</h4>
          <form class="grid-4" id="add-user-form">
            <div class="form-group">
              <label for="new-username"><i class="fas fa-user"></i> Username</label>
              <input type="text" id="new-username" required minlength="3" maxlength="50" placeholder="Enter username">
              <div class="validation-error">Username required (3-50 characters, alphanumeric only)</div>
              <div class="validation-success hidden">✓ Username available</div>
            </div>
            
            <div class="form-group">
              <label for="new-email"><i class="fas fa-envelope"></i> Email Address</label>
              <input type="email" id="new-email" required placeholder="user@example.com">
              <div class="validation-error">Valid email address required</div>
            </div>
            
            <div class="form-group">
              <label for="new-role"><i class="fas fa-user-tag"></i> Role</label>
              <select id="new-role" required>
                <option value="">Select Role</option>
                <option value="admin">👑 Admin (Full Access)</option>
                <option value="editor">✏️ Editor (Read/Write)</option>
                <option value="viewer">👁️ Viewer (Read Only)</option>
                <option value="auditor">🔍 Auditor (Audit Access)</option>
              </select>
              <div class="validation-error">Role selection required</div>
            </div>
            
            <div class="form-group">
              <label for="new-department"><i class="fas fa-building"></i> Department</label>
              <select id="new-department" required>
                <option value="">Select Department</option>
                <option value="finance">💰 Finance</option>
                <option value="operations">⚙️ Operations</option>
                <option value="compliance">📋 Compliance</option>
                <option value="audit">🔍 Audit</option>
                <option value="management">👔 Management</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="new-password"><i class="fas fa-lock"></i> Password</label>
              <input type="password" id="new-password" required minlength="8" placeholder="Minimum 8 characters">
              <div class="password-strength-meter">
                <div class="strength-bar"></div>
                <span class="strength-text">Password Strength</span>
              </div>
              <div class="validation-error">Password must be 8+ characters with uppercase, lowercase, number, and special character</div>
            </div>
            
            <div class="form-group">
              <label for="confirm-password"><i class="fas fa-check-circle"></i> Confirm Password</label>
              <input type="password" id="confirm-password" required placeholder="Confirm password">
              <div class="validation-error">Passwords must match</div>
            </div>
            
            <div class="form-group">
              <label for="user-expires"><i class="fas fa-calendar-alt"></i> Account Expires</label>
              <input type="date" id="user-expires">
              <small>Leave blank for no expiration</small>
            </div>
            
            <div class="form-group">
              <label class="checkbox-label">
                <input type="checkbox" id="force-password-change" checked>
                <i class="fas fa-key"></i> Force password change on first login
              </label>
            </div>
            
            <div class="form-group" style="grid-column: 1 / -1; display: flex; gap: 1rem; justify-content: flex-end;">
              <button type="button" class="btn btn-secondary" id="cancel-user-form">
                <i class="fas fa-times"></i> Cancel
              </button>
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-user-plus"></i> Create User
              </button>
            </div>
          </form>
        </div>

        <!-- Enhanced Users Table with Security Info -->
        <div class="table-container">
          <div class="table-header">
            <h4><i class="fas fa-users-cog"></i> User Accounts</h4>
            <div class="table-filters">
              <select id="role-filter">
                <option value="">All Roles</option>
                <option value="admin">Admin</option>
                <option value="editor">Editor</option>
                <option value="viewer">Viewer</option>
                <option value="auditor">Auditor</option>
              </select>
              <select id="status-filter">
                <option value="">All Status</option>
                <option value="active">Active</option>
                <option value="locked">Locked</option>
                <option value="expired">Expired</option>
              </select>
              <input type="search" id="user-search" placeholder="🔍 Search users...">
            </div>
          </div>
          <table>
            <thead>
              <tr>
                <th><i class="fas fa-user"></i> User</th>
                <th><i class="fas fa-envelope"></i> Email</th>
                <th><i class="fas fa-user-tag"></i> Role</th>
                <th><i class="fas fa-building"></i> Department</th>
                <th><i class="fas fa-circle"></i> Status</th>
                <th><i class="fas fa-clock"></i> Last Login</th>
                <th><i class="fas fa-exclamation-circle"></i> Failed Attempts</th>
                <th><i class="fas fa-calendar"></i> Expires</th>
                <th><i class="fas fa-cogs"></i> Actions</th>
              </tr>
            </thead>
            <tbody id="users-table">
              <!-- Users will be populated here -->
            </tbody>
          </table>
        </div>

        <!-- Audit Log Modal -->
        <div id="audit-log-modal" class="modal hidden">
          <div class="modal-content">
            <div class="modal-header">
              <h3><i class="fas fa-shield-alt"></i> Security Audit Log</h3>
              <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
              <div class="audit-filters">
                <div class="form-group">
                  <label>From Date</label>
                  <input type="date" id="audit-date-from">
                </div>
                <div class="form-group">
                  <label>To Date</label>
                  <input type="date" id="audit-date-to">
                </div>
                <div class="form-group">
                  <label>Action Type</label>
                  <select id="audit-action-filter">
                    <option value="">All Actions</option>
                    <option value="login">Login</option>
                    <option value="logout">Logout</option>
                    <option value="create_user">Create User</option>
                    <option value="modify_user">Modify User</option>
                    <option value="delete_user">Delete User</option>
                    <option value="failed_login">Failed Login</option>
                    <option value="password_change">Password Change</option>
                  </select>
                </div>
                <button class="btn btn-primary" id="filter-audit-log">
                  <i class="fas fa-filter"></i> Apply Filters
                </button>
              </div>
              <div class="table-container">
                <table>
                  <thead>
                    <tr>
                      <th>Timestamp</th>
                      <th>User</th>
                      <th>Action</th>
                      <th>Target</th>
                      <th>IP Address</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody id="audit-log-table">
                    <!-- Audit log entries will be populated here -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section id="royalty-records" class="content-section enhanced-royalty-records">
        <div class="royalty-header">
          <h3>Royalty Records</h3>
          <p class="subtitle">Manage and review all royalty payments</p>
        </div>
        <div class="royalty-form">
          <h4>Record Royalty Payment</h4>
          <form class="grid-4-inputs" id="royalty-form">
            <div class="form-group">
              <label for="entity">Entity</label>
              <select id="entity" required>
                <option value="">Select Entity</option>
                <option value="Kwalini Quarry">Kwalini Quarry</option>
                <option value="Mbabane Quarry">Mbabane Quarry</option>
                <option value="Sidvokodvo Quarry">Sidvokodvo Quarry</option>
                <option value="Maloma Colliery">Maloma Colliery</option>
                <option value="Ngwenya Mine">Ngwenya Mine</option>
                <option value="Malolotja Mine">Malolotja Mine</option>
              </select>
              <div class="validation-error">Entity is required</div>
            </div>
            <div class="form-group">
              <label for="mineral">Mineral</label>
              <select id="mineral" required>
                <option value="">Select Mineral</option>
                <option value="Coal">Coal</option>
                <option value="Iron Ore">Iron Ore</option>
                <option value="Green Chert">Green Chert</option>
                <option value="Gravel">Gravel</option>
                <option value="River Sand">River Sand</option>
                <option value="Plaster Sand">Plaster Sand</option>
                <option value="Quarried Stone">Quarried Stone</option>
              </select>
              <div class="validation-error">Mineral is required</div>
            </div>
            <div class="form-group">
              <label for="volume">Volume (m³)</label>
              <input type="number" id="volume" min="0" step="0.01" required>
              <div class="validation-error">Volume must be a positive number</div>
            </div>
            <div class="form-group">
              <label for="tariff">Royalty Tariff (E/m³)</label>
              <input type="number" id="tariff" min="0" step="0.01" value="15.00" required>
              <div class="validation-error">Tariff must be a positive number</div>
            </div>
            <div class="form-group">
              <label for="royalty-date">Date</label>
              <input type="date" id="royalty-date" required>
              <div class="validation-error">Date is required</div>
            </div>
            <button type="submit" class="btn-primary">Save Royalty</button>
          </form>
        </div>
        <hr class="royalty-divider">
        <div class="royalty-table">
          <h4>Royalty Records Table</h4>
          <div class="filters">
            <div class="form-group">
              <label for="filter-entity">Entity</label>
              <select id="filter-entity">
                <option value="">All Entities</option>
                <option value="Kwalini Quarry">Kwalini Quarry</option>
                <option value="Mbabane Quarry">Mbabane Quarry</option>
                <option value="Sidvokodvo Quarry">Sidvokodvo Quarry</option>
                <option value="Maloma Colliery">Maloma Colliery</option>
                <option value="Ngwenya Mine">Ngwenya Mine</option>
                <option value="Malolotja Mine">Malolotja Mine</option>
              </select>
            </div>
            <button class="btn-primary">Apply Filters</button>
            <button class="btn-secondary" id="export-royalties">Export Report</button>
          </div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Entity</th>
                  <th>Mineral</th>
                  <th>Volume (m³)</th>
                  <th>Tariff (E/m³)</th>
                  <th>Royalties (E)</th>
                  <th>Date</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="royalties-table"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="contract-management" class="content-section">
        <div class="page-header">
          <div class="page-title">
            <h1>Contract Management</h1>
            <p>Manage royalty agreements for mines and quarries</p>
          </div>
        </div>
        <div class="contract-form">
          <h4>Add Contract</h4>
          <form class="grid-3" id="contract-form">
            <div class="form-group">
              <label for="contract-entity">Entity</label>
              <select id="contract-entity" required>
                <option value="">Select Entity</option>
                <option value="Kwalini Quarry">Kwalini Quarry</option>
                <option value="Mbabane Quarry">Mbabane Quarry</option>
                <option value="Sidvokodvo Quarry">Sidvokodvo Quarry</option>
                <option value="Maloma Colliery">Maloma Colliery</option>
                <option value="Ngwenya Mine">Ngwenya Mine</option>
                <option value="Malolotja Mine">Malolotja Mine</option>
              </select>
            </div>
            <div class="form-group">
              <label for="contract-rate">Royalty Rate (E/m³)</label>
              <input type="number" id="contract-rate" min="0" step="0.01" value="15.00" required>
            </div>
            <div class="form-group">
              <label for="contract-start">Start Date</label>
              <input type="date" id="contract-start" required>
            </div>
            <button type="submit" class="btn-primary">Save Contract</button>
          </form>
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Entity</th>
                <th>Royalty Rate (E/m³)</th>
                <th>Start Date</th>
                <th>Document</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="contracts-table"></tbody>
          </table>
        </div>
      </section>

      <section id="audit-dashboard" class="content-section">
        <div class="audit-header">
          <h3>Audit Dashboard</h3>
          <p class="subtitle">Review discrepancies and audit reports</p>
        </div>
        <div class="filters">
          <div class="form-group">
            <label for="audit-entity">Entity</label>
            <select id="audit-entity">
              <option value="">All Entities</option>
              <option value="Kwalini Quarry">Kwalini Quarry</option>
              <option value="Mbabane Quarry">Mbabane Quarry</option>
              <option value="Sidvokodvo Quarry">Sidvokodvo Quarry</option>
              <option value="Maloma Colliery">Maloma Colliery</option>
              <option value="Ngwenya Mine">Ngwenya Mine</option>
              <option value="Malolotja Mine">Malolotja Mine</option>
            </select>
          </div>
          <button class="btn-primary">Apply Filters</button>
          <button class="btn-secondary" id="export-audit">Export Audit Report</button>
        </div>
        <div class="audit-table">
          <h4>Discrepancies</h4>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Project</th>
                  <th>Mineral</th>
                  <th>Declared (m³)</th>
                  <th>Verified (m³)</th>
                  <th>Outstanding (E)</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="discrepancies-table"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="reporting-analytics" class="content-section">
        <div class="page-header">
          <div class="page-title">
            <h1>Reporting & Analytics</h1>
            <p>Generate royalty and audit reports</p>
          </div>
        </div>
        <div class="reports-section">
          <h3>Generate Reports</h3>
          <form class="grid-3" id="report-form">
            <div class="form-group">
              <label for="report-type">Report Type</label>
              <select id="report-type" required>
                <option value="">Select Report Type</option>
                <option value="royalty-summary">Royalty Summary</option>
                <option value="audit-discrepancies">Audit Discrepancies</option>
              </select>
            </div>
            <div class="form-group">
              <label for="report-entity">Entity</label>
              <select id="report-entity">
                <option value="">All Entities</option>
                <option value="Kwalini Quarry">Kwalini Quarry</option>
                <option value="Mbabane Quarry">Mbabane Quarry</option>
                <option value="Sidvokodvo Quarry">Sidvokodvo Quarry</option>
                <option value="Maloma Colliery">Maloma Colliery</option>
                <option value="Ngwenya Mine">Ngwenya Mine</option>
                <option value="Malolotja Mine">Malolotja Mine</option>
              </select>
            </div>
            <div class="form-group">
              <label for="report-date">Date Range</label>
              <select id="report-date">
                <option value="2024">2024</option>
                <option value="2025">2025</option>
              </select>
            </div>
            <button type="submit" class="btn-primary">Generate Report</button>
          </form>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Report Name</th>
                  <th>Type</th>
                  <th>Entity</th>
                  <th>Date</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="reports-table"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="compliance" class="content-section">
        <div class="page-header">
          <div class="page-title">
            <h1>Compliance Dashboard</h1>
          </div>
        </div>
        <div class="charts-grid">
          <div class="card">
            <div class="card-header"><h3>Submission Deadlines</h3></div>
            <div class="card-body"><p id="deadlines">Next deadline: 30/06/2025</p></div>
          </div>
          <div class="card">
            <div class="card-header"><h3>Discrepancy Alerts</h3></div>
            <div class="card-body"><p id="discrepancy-alerts">1 discrepancy found</p></div>
          </div>
        </div>
      </section>

      <script>
        // Data from document
        const entities = [
          { name: 'Kwalini Quarry', type: 'Quarry', tariff: 15.00 },
          { name: 'Mbabane Quarry', type: 'Quarry', tariff: 15.00 },
          { name: 'Sidvokodvo Quarry', type: 'Quarry', tariff: 15.00 },
          { name: 'Maloma Colliery', type: 'Mine', tariff: 5.00 },
          { name: 'Ngwenya Mine', type: 'Mine', tariff: 5.00 },
          { name: 'Malolotja Mine', type: 'Mine', tariff: 5.00 }
        ];
        const minerals = ['Coal', 'Iron Ore', 'Green Chert', 'Gravel', 'River Sand', 'Plaster Sand', 'Quarried Stone'];
        const royaltyRecords = [
          { entity: 'Kwalini Quarry', mineral: 'Gravel', volume: 10352, tariff: 15.00, date: '2024-06-30', status: 'Verified' },
          { entity: 'Kwalini Quarry', mineral: 'Gravel', volume: 11254, tariff: 15.00, date: '2024-09-30', status: 'Verified' },
          { entity: 'Kwalini Quarry', mineral: 'Gravel', volume: 12569, tariff: 15.00, date: '2024-12-31', status: 'Verified' },
          { entity: 'Kwalini Quarry', mineral: 'Gravel', volume: 12546, tariff: 15.00, date: '2025-03-31', status: 'Verified' },
          { entity: 'Mbabane Quarry', mineral: 'Gravel', volume: 9653, tariff: 15.00, date: '2024-06-30', status: 'Verified' },
          { entity: 'Mbabane Quarry', mineral: 'Gravel', volume: 10589, tariff: 15.00, date: '2024-09-30', status: 'Verified' },
          { entity: 'Mbabane Quarry', mineral: 'Gravel', volume: 11258, tariff: 15.00, date: '2024-12-31', status: 'Verified' },
          { entity: 'Mbabane Quarry', mineral: 'Gravel', volume: 12356, tariff: 15.00, date: '2025-03-31', status: 'Verified' }
        ];
        const auditData = [
          {
            project: 'Rehabilitation of Nkomazi and Malanti Culvert',
            discrepancies: [
              { mineral: 'Gravel', declared: 5000, verified: 11350, tariff: 5.00 },
              { mineral: 'River Sand', declared: 350, verified: 470, tariff: 5.00 },
              { mineral: 'Quarried Stone', declared: 3500, verified: 8000, tariff: 5.00 }
            ]
          }
        ];

        let currentUser = null;

        // Define all functions first before they are called
        function updateRoyaltiesTable(data) {
          const tableBody = document.querySelector('#royalties-table');
          if (!tableBody) return;
          
          tableBody.innerHTML = data.map((r, index) => `
            <tr>
              <td>${r.entity || 'N/A'}</td>
              <td>${r.mineral || 'N/A'}</td>
              <td>${(r.volume || 0).toFixed(2)}</td>
              <td>${(r.tariff || 0).toFixed(2)}</td>
              <td>E${(r.royalties || 0).toFixed(2)}</td>
              <td>${r.date || 'N/A'}</td>
              <td><span class="status-badge ${(r.status || 'pending').toLowerCase()}">${r.status || 'Pending'}</span></td>
              <td class="table-actions">
                <button class="btn btn-sm btn-primary" onclick="editRoyalty(${r.id || index})">Edit</button>
                <button class="btn btn-sm btn-danger" onclick="deleteRoyalty(${r.id || index})">Delete</button>
              </td>
            </tr>
          `).join('');
        }
        
        function updateContractsTable(contracts) {
          const table = document.querySelector('#contracts-table');
          if (!table) return;
          
          table.innerHTML = contracts.map((c, index) => `
            <tr>
              <td>${c.entity || 'N/A'}</td>
              <td>${(c.rate || 0).toFixed(2)}</td>
              <td>${c.startDate || 'N/A'}</td>
              <td><a href="#" onclick="downloadContract('${c.entity || 'Unknown'}')">View Contract</a></td>
              <td>
                <button class="btn btn-sm btn-primary" onclick="editContract(${c.id || index})">Edit</button>
              </td>
            </tr>
          `).join('');
        }
        
        function updateAuditTable(data) {
          const tableBody = document.querySelector('#discrepancies-table');
          if (!tableBody) return;
          
          tableBody.innerHTML = data.flatMap(project => 
            project.discrepancies.map(d => `
              <tr>
                <td>${project.project || 'N/A'}</td>
                <td>${d.mineral || 'N/A'}</td>
                <td>${(d.declared || 0).toFixed(2)}</td>
                <td>${(d.verified || 0).toFixed(2)}</td>
                <td>E${(((d.verified || 0) - (d.declared || 0)) * (d.tariff || 0)).toFixed(2)}</td>
                <td><span class="status-badge pending">Pending</span></td>
              </tr>
            `)
          ).join('');
        }

        function updateDashboard(data) {
          if (!data || data.length === 0) {
            document.getElementById('total-royalties').textContent = 'E0.00';
            document.getElementById('active-entities').textContent = '0';
            document.getElementById('compliance-rate').textContent = '0%';
            document.getElementById('pending-approvals').textContent = '0';
            document.getElementById('royalty-trend').textContent = '+0% from last year';
            return;
          }

          const totalRoyalties = data.reduce((sum, r) => sum + (r.royalties || 0), 0);
          const activeEntities = new Set(data.map(r => r.entity).filter(Boolean)).size;
          const verifiedCount = data.filter(r => r.status === 'Verified').length;
          const complianceRate = data.length > 0 ? (verifiedCount / data.length * 100).toFixed(1) : '0';
          const pendingApprovals = data.filter(r => r.status === 'Pending').length;
          
          document.getElementById('total-royalties').textContent = `E${totalRoyalties.toFixed(2)}`;
          document.getElementById('active-entities').textContent = activeEntities;
          document.getElementById('compliance-rate').textContent = `${complianceRate}%`;
          document.getElementById('pending-approvals').textContent = pendingApprovals;
          
          const lastYear = data.filter(r => r.date && new Date(r.date).getFullYear() === 2024)
                               .reduce((sum, r) => sum + (r.royalties || 0), 0);
          const trend = lastYear ? ((totalRoyalties - lastYear) / lastYear * 100).toFixed(1) : 0;
          document.getElementById('royalty-trend').textContent = `${trend > 0 ? '+' : ''}${trend}% from last year`;
          
          if (pendingApprovals > 0) {
            addNotification(`${pendingApprovals} pending royalty approvals`);
          }
        }
        
        function renderCharts(data) {
          if (!window.Chart || !data || data.length === 0) return;
          
          try {
            const trendsCtx = document.getElementById('royalty-trends-chart');
            const mineralCtx = document.getElementById('mineral-distribution-chart');
            
            if (!trendsCtx || !mineralCtx) return;
            
            const trendsContext = trendsCtx.getContext('2d');
            const mineralContext = mineralCtx.getContext('2d');
            
            const monthlyData = {};
            data.forEach(r => {
              if (r.date && r.royalties) {
                const month = r.date.slice(0, 7);
                monthlyData[month] = (monthlyData[month] || 0) + r.royalties;
              }
            });
            
            // Clear existing charts
            Chart.getChart(trendsCtx)?.destroy();
            Chart.getChart(mineralCtx)?.destroy();
            
            new Chart(trendsContext, {
              type: 'line',
              data: {
                labels: Object.keys(monthlyData),
                datasets: [{
                  label: 'Royalty Payments (E)',
                  data: Object.values(monthlyData),
                  borderColor: '#2563eb',
                  backgroundColor: 'rgba(37, 99, 235, 0.1)',
                  fill: true
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false
              }
            });
            
            const mineralCounts = minerals.reduce((acc, m) => { 
              acc[m] = data.filter(r => r.mineral === m).reduce((sum, r) => sum + (r.volume || 0), 0); 
              return acc; 
            }, {});
            
            // Filter out minerals with zero volume
            const filteredMineralData = Object.entries(mineralCounts)
              .filter(([, volume]) => volume > 0)
              .reduce((acc, [mineral, volume]) => {
                acc.labels.push(mineral);
                acc.data.push(volume);
                return acc;
              }, { labels: [], data: [] });
            
            new Chart(mineralContext, {
              type: 'pie',
              data: {
                labels: filteredMineralData.labels,
                datasets: [{
                  label: 'Volume by Mineral (m³)',
                  data: filteredMineralData.data,
                  backgroundColor: ['#ff6384', '#36a2eb', '#ffce56', '#4bc0c0', '#9966ff', '#ff9f40', '#c9cbcf']
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false
              }
            });
          } catch (error) {
            console.error('Error rendering charts:', error);
          }
        }

        function initializeWithDummyData() {
          console.log('Initializing with dummy data due to database error');
          const dummyRoyalties = royaltyRecords.map((r, index) => ({
            ...r, 
            id: index + 1,
            royalties: r.volume * r.tariff
          }));
          const dummyContracts = entities.map((e, index) => ({
            id: index + 1, 
            entity: e.name, 
            rate: e.tariff, 
            startDate: '2024-01-01'
          }));
          
          updateDashboard(dummyRoyalties);
          updateRoyaltiesTable(dummyRoyalties);
          updateContractsTable(dummyContracts);
          updateAuditTable(auditData);
          
          if (window.Chart) {
            renderCharts(dummyRoyalties);
          }
        }

        function addNotification(message) {
          const count = parseInt(document.querySelector('#notification-count').textContent || '0');
          document.getElementById('notification-count').textContent = count + 1;
          document.getElementById('dashboard-notification-count').textContent = count + 1;
          
          // Create notification element if notifications section exists
          const notificationsSection = document.querySelector('#notifications');
          if (notificationsSection) {
            let notificationsList = notificationsSection.querySelector('.notifications-list');
            if (!notificationsList) {
              notificationsList = document.createElement('div');
              notificationsList.className = 'notifications-list';
              notificationsSection.appendChild(notificationsList);
            }
            
            const div = document.createElement('div');
            div.className = 'notification-item';
            div.innerHTML = `
              <div class="notification-content">
                <strong>${new Date().toLocaleString()}</strong>
                <p>${message}</p>
              </div>
            `;
            notificationsList.insertBefore(div, notificationsList.firstChild);
          }
          
          console.log(`Notification: ${message}`);
        }

        // Add missing sections for notifications and profile
        function addMissingSections() {
          const mainContent = document.querySelector('.main-content');
          
          // Add notifications section if missing
          if (!document.querySelector('#notifications')) {
            const notificationsSection = document.createElement('section');
            notificationsSection.id = 'notifications';
            notificationsSection.className = 'content-section';
            notificationsSection.innerHTML = `
              <div class="page-header">
                <div class="page-title">
                  <h1>Notifications</h1>
                  <p>View system notifications and alerts</p>
                </div>
              </div>
              <div class="notifications-list">
                <div class="notification-item">
                  <div class="notification-content">
                    <strong>System</strong>
                    <p>Welcome to the Mining Royalties Manager</p>
                  </div>
                </div>
              </div>
            `;
            mainContent.appendChild(notificationsSection);
          }
          
          // Add profile section if missing
          if (!document.querySelector('#my-profile')) {
            const profileSection = document.createElement('section');
            profileSection.id = 'my-profile';
            profileSection.className = 'content-section';
            profileSection.innerHTML = `
              <div class="page-header">
                <div class="page-title">
                  <h1>My Profile</h1>
                  <p>Manage your account settings</p>
                </div>
              </div>
              <div class="card">
                <div class="card-header">
                  <h3>Profile Information</h3>
                </div>
                <div class="card-body">
                  <p><strong>Username:</strong> <span id="profile-username">-</span></p>
                  <p><strong>Role:</strong> <span id="profile-role">-</span></p>
                  <p><strong>Last Login:</strong> <span id="profile-last-login">${new Date().toLocaleString()}</span></p>
                </div>
              </div>
            `;
            mainContent.appendChild(profileSection);
          }
        }

        function updateProfileInfo() {
          if (currentUser) {
            const profileUsername = document.querySelector('#profile-username');
            const profileRole = document.querySelector('#profile-role');
            
            if (profileUsername) profileUsername.textContent = currentUser.username || 'N/A';
            if (profileRole) profileRole.textContent = currentUser.role || 'N/A';
          }
        }

        function showLoginError(message) {
          const errorMessage = document.querySelector('.error-message');
          if (errorMessage) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
          }
          console.error('Login error:', message);
        }

        // Placeholder functions
        function editRoyalty(id) {
          console.log('Edit royalty', id);
        }
        
        function deleteRoyalty(id) {
          console.log('Delete royalty', id);
        }
        
        function editContract(id) {
          console.log('Edit contract', id);
        }
        
        function downloadContract(entity) {
          alert(`Simulated download of contract for ${entity}`);
        }

        window.addEventListener('load', async () => {
          // Ensure only login section is visible initially
          const loginSection = document.querySelector('.login-section');
          const appContainer = document.querySelector('.app-container');
          const sidebar = document.querySelector('.sidebar');
          
          // Force login page to be visible
          if (loginSection) {
            loginSection.classList.remove('hidden');
            loginSection.style.display = 'flex';
          }
          
          // Force main app to be hidden
          if (appContainer) {
            appContainer.classList.add('hidden');
            appContainer.style.display = 'none';
          }
          
          // Force sidebar to be hidden
          if (sidebar) {
            sidebar.classList.add('hidden');
            sidebar.style.display = 'none';
          }

          // Library checks
          if (!window.Chart) {
            console.error('Chart.js failed to load');
            const trendsChart = document.querySelector('#royalty-trends-chart');
            if (trendsChart && trendsChart.parentElement) {
              trendsChart.parentElement.innerHTML = '<div class="chart-empty"><i class="fas fa-exclamation-circle"></i><p>Chart failed to load</p></div>';
            }
          }
          if (!window.jspdf) {
            console.error('jsPDF failed to load');
            const exportRoyalties = document.querySelector('#export-royalties');
            const exportAudit = document.querySelector('#export-audit');
            if (exportRoyalties) exportRoyalties.disabled = true;
            if (exportAudit) exportAudit.disabled = true;
          }

          // Hide loading screen
          setTimeout(() => {
            const loadingScreen = document.querySelector('.loading-screen');
            if (loadingScreen) loadingScreen.style.display = 'none';
          }, 1000);

          // Add missing sections first (but keep them hidden)
          addMissingSections();

          // Only initialize dummy data after successful login to avoid premature notifications
          let isDataInitialized = false;

          // Enhanced authentication function
          function authenticateUser(user, username) {
            console.log('Authenticating user:', username);
            
            currentUser = user;
            
            // Initialize data only once after login
            if (!isDataInitialized) {
              initializeWithDummyData();
              isDataInitialized = true;
            }
            
            // Update user display
            const userNameElement = document.getElementById('user-name');
            const userRoleElement = document.getElementById('user-role');
            
            if (userNameElement) userNameElement.textContent = username;
            if (userRoleElement) userRoleElement.textContent = user.role;
            
            // Update profile info
            updateProfileInfo();
            
            // Hide login section and show app
            const loginSection = document.querySelector('.login-section');
            const appContainer = document.querySelector('.app-container');
            const sidebar = document.querySelector('.sidebar');
            
            if (loginSection) {
              loginSection.classList.add('hidden');
              loginSection.style.display = 'none';
            }
            if (appContainer) {
              appContainer.classList.remove('hidden');
              appContainer.style.display = 'block';
              appContainer.classList.add('show');
            }
            
            // Ensure sidebar is visible after login
            if (sidebar) {
              sidebar.classList.remove('hidden');
              sidebar.style.display = 'block';
            }
            
            // Hide user management for non-admin users
            if (user.role !== 'admin') {
              const userMgmt = document.querySelector('#user-management');
              if (userMgmt) userMgmt.classList.add('hidden');
            }
            
            // Clear any error messages
            const errorMessage = document.querySelector('.error-message');
            if (errorMessage) errorMessage.classList.add('hidden');
            
            // Add welcome notification
            addNotification(`Welcome back, ${username}!`);
            
            console.log('Authentication complete');
          }

          // Login handler with better error handling
          const loginForm = document.getElementById('login-form');
          if (loginForm) {
            loginForm.addEventListener('submit', (e) => {
              e.preventDefault();
              e.stopPropagation();
              
              const usernameInput = document.getElementById('username');
              const passwordInput = document.getElementById('password');
              
              if (!usernameInput || !passwordInput) {
                console.error('Login form inputs not found');
                return false;
              }
              
              const username = usernameInput.value.trim();
              const password = passwordInput.value.trim();
              
              console.log('Login attempt:', username);
              
              if (!username || !password) {
                showLoginError('Please enter both username and password');
                return false;
              }
              
              // Clear any previous errors
              const errorMessage = document.querySelector('.error-message');
              if (errorMessage) errorMessage.classList.add('hidden');
              
              // Hardcoded users for demo (fallback authentication)
              const users = [
                { username: 'admin', password: 'admin123', role: 'admin' },
                { username: 'editor', password: 'editor123', role: 'editor' },
                { username: 'viewer', password: 'viewer123', role: 'viewer' }
              ];
              
              const user = users.find(u => u.username === username && u.password === password);
              
              if (user) {
                console.log('Login successful for:', username);
                authenticateUser(user, username);
              } else {
                console.log('Login failed for:', username);
                showLoginError('Invalid username or password. Try: admin/admin123 or editor/editor123');
              }
              
              return false;
            });
          }

          // Simplified IndexedDB initialization (optional, non-blocking)
          try {
            const dbRequest = indexedDB.open('RoyaltiesDB', 1);
            
            dbRequest.onupgradeneeded = (event) => {
              const db = event.target.result;
              
              if (!db.objectStoreNames.contains('royalties')) {
                db.createObjectStore('royalties', { keyPath: 'id', autoIncrement: true });
              }
              if (!db.objectStoreNames.contains('users')) {
                db.createObjectStore('users', { keyPath: 'id', autoIncrement: true });
              }
              if (!db.objectStoreNames.contains('contracts')) {
                db.createObjectStore('contracts', { keyPath: 'id', autoIncrement: true });
              }
            };
            
            dbRequest.onsuccess = (event) => {
              console.log('Database initialized successfully');
            };
            
            dbRequest.onerror = (event) => {
              console.log('Database initialization failed, using in-memory storage');
            };
            
          } catch (error) {
            console.log('IndexedDB not available, using in-memory storage');
          }

          // Form submissions with simplified error handling
          document.getElementById('royalty-form').addEventListener('submit', (e) => {
            e.preventDefault();
            
            if (!currentUser) {
              alert('Please log in first');
              return;
            }
            
            const record = {
              entity: document.getElementById('entity').value,
              mineral: document.getElementById('mineral').value,
              volume: parseFloat(document.getElementById('volume').value),
              tariff: parseFloat(document.getElementById('tariff').value),
              royalties: parseFloat(document.getElementById('volume').value) * parseFloat(document.getElementById('tariff').value),
              date: document.getElementById('royalty-date').value,
              status: 'Pending'
            };
            
            // Add to dummy data for demonstration
            const dummyRoyalties = royaltyRecords.map((r, index) => ({
              ...r, 
              id: index + 1,
              royalties: r.volume * r.tariff
            }));
            
            const newRecord = {
              ...record,
              id: dummyRoyalties.length + 1
            };
            
            dummyRoyalties.push(newRecord);
            
            updateRoyaltiesTable(dummyRoyalties);
            updateDashboard(dummyRoyalties);
            if (window.Chart) {
              renderCharts(dummyRoyalties);
            }
            
            addNotification('New royalty record added');
            document.getElementById('royalty-form').reset();
          });

          // Contract form submission
          document.getElementById('contract-form').addEventListener('submit', (e) => {
            e.preventDefault();
            
            if (!currentUser) {
              alert('Please log in first');
              return;
            }
            
            const contract = {
              entity: document.getElementById('contract-entity').value,
              rate: parseFloat(document.getElementById('contract-rate').value),
              startDate: document.getElementById('contract-start').value
            };
            
            addNotification('New contract added');
            document.getElementById('contract-form').reset();
          });

          // Report generation with simplified implementation
          document.getElementById('report-form').addEventListener('submit', (e) => {
            e.preventDefault();
            
            if (!currentUser) {
              alert('Please log in first');
              return;
            }
            
            const type = document.getElementById('report-type').value;
            const entity = document.getElementById('report-entity').value;
            const date = document.getElementById('report-date').value;
            
            if (window.jspdf && type === 'royalty-summary') {
              const { jsPDF } = window.jspdf;
              const doc = new jsPDF();
              doc.text('Royalty Summary Report', 20, 20);
              doc.text(`Entity: ${entity || 'All Entities'}, Date: ${date}`, 20, 30);
              doc.save(`royalty_${entity || 'all'}_${date}.pdf`);
              addNotification('Royalty report generated');
            } else if (window.jspdf && type === 'audit-discrepancies') {
              const { jsPDF } = window.jspdf;
              const doc = new jsPDF();
              doc.text('Audit Discrepancy Report', 20, 20);
              doc.save('audit_discrepancy_report.pdf');
              addNotification('Audit report generated');
            } else {
              addNotification('Report generated (PDF library not available)');
            }
          });

          // Navigation handling
          const navLinks = document.querySelectorAll('.nav-link');
          
          // Show dashboard by default
          document.querySelectorAll('.content-section').forEach(section => section.style.display = 'none');
          const dashboardSection = document.getElementById('dashboard');
          if (dashboardSection) dashboardSection.style.display = 'block';
          
          navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
              e.preventDefault();
              const targetId = link.getAttribute('href').substring(1);
              
              // Hide all sections
              document.querySelectorAll('.content-section').forEach(section => section.style.display = 'none');
              
              // Show target section
              const targetSection = document.getElementById(targetId);
              if (targetSection) {
                targetSection.style.display = 'block';
              } else {
                console.warn(`Section ${targetId} not found`);
              }
              
              // Update active link
              navLinks.forEach(l => l.classList.remove('active'));
              link.classList.add('active');
            });
          });
          
          // Set dashboard as active
          const dashboardLink = document.querySelector('a[href="#dashboard"]');
          if (dashboardLink) {
            dashboardLink.classList.add('active');
          }

          // Logout functionality
          const logoutBtn = document.querySelector('.logout-btn');
          if (logoutBtn) {
            logoutBtn.addEventListener('click', () => {
              currentUser = null;
              isDataInitialized = false; // Reset data initialization flag
              
              const loginSection = document.querySelector('.login-section');
              const appContainer = document.querySelector('.app-container');
              const sidebar = document.querySelector('.sidebar');
              const usernameInput = document.getElementById('username');
              const passwordInput = document.getElementById('password');
              
              // Show login page
              if (loginSection) {
                loginSection.classList.remove('hidden');
                loginSection.style.display = 'flex';
              }
              
              // Hide main app
              if (appContainer) {
                appContainer.classList.add('hidden');
                appContainer.style.display = 'none';
              }
              
              // Hide sidebar
              if (sidebar) {
                sidebar.classList.add('hidden');
                sidebar.style.display = 'none';
              }
              
              // Clear form inputs
              if (usernameInput) usernameInput.value = '';
              if (passwordInput) passwordInput.value = '';
              
              // Clear any error messages
              const errorMessage = document.querySelector('.error-message');
              if (errorMessage) errorMessage.classList.add('hidden');
            });
          }

          // Mobile menu toggle
          const mobileMenuToggle = document.querySelector('.mobile-menu-toggle');
          if (mobileMenuToggle) {
            mobileMenuToggle.addEventListener('click', () => {
              const sidebar = document.querySelector('.sidebar');
              if (sidebar) sidebar.classList.toggle('sidebar-mobile-open');
            });
          }

          // Sidebar close button (for mobile)
          const sidebarClose = document.querySelector('.sidebar-close');
          if (sidebarClose) {
            sidebarClose.addEventListener('click', () => {
              const sidebar = document.querySelector('.sidebar');
              if (sidebar) sidebar.classList.remove('sidebar-mobile-open');
            });
          }

          // Hide loading screen
          setTimeout(() => {
            const loadingScreen = document.querySelector('.loading-screen');
            if (loadingScreen) loadingScreen.style.display = 'none';
          }, 1000);
        });
      </script>
    </div>
  </div>
</body>
</html>