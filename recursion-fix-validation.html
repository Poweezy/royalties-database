<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Infinite Recursion Fix Validation</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
        .test-results {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ðŸš€ Infinite Recursion Fix Validation</h1>
        <div class="status info">
            <strong>Testing:</strong> Verify that the infinite recursion in the final-system-unification.js has been completely resolved.
        </div>
        
        <button onclick="testRecursionFix()">Test Recursion Fix</button>
        <button onclick="testChartManagerDirect()">Test Chart Manager Direct</button>
        <button onclick="runMainApplicationTest()">Test Main Application</button>
        <button onclick="clearResults()">Clear Results</button>
        
        <div id="results" class="test-results"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const element = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : type === 'warning' ? 'âš ï¸' : 'â„¹ï¸';
            element.innerHTML += `${prefix} [${timestamp}] ${message}\n`;
            element.scrollTop = element.scrollHeight;
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        function testRecursionFix() {
            clearResults();
            log('ðŸ” Testing Infinite Recursion Fix...', 'info');
            
            // Monitor console for recursion warnings
            const originalConsoleWarn = console.warn;
            let recursionWarnings = 0;
            let infiniteRecursionDetected = false;
            
            console.warn = function(...args) {
                const message = args.join(' ');
                if (message.includes('infinite recursion') || message.includes('Preventing infinite recursion')) {
                    recursionWarnings++;
                    infiniteRecursionDetected = true;
                    log(`Recursion warning detected: ${message}`, 'warning');
                }
                originalConsoleWarn.apply(console, args);
            };

            try {
                // Load the main application in an iframe to test
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.src = './royalties.html';
                document.body.appendChild(iframe);

                setTimeout(() => {
                    try {
                        const appWindow = iframe.contentWindow;
                        
                        // Test basic chart manager access
                        if (appWindow.window.chartManager) {
                            log('Chart manager found in loaded application', 'success');
                            
                            // Test method calls that previously caused recursion
                            const testMethods = ['createRevenueChart', 'createProductionChart', 'createEntityChart'];
                            let methodsWorking = 0;
                            
                            testMethods.forEach(method => {
                                if (typeof appWindow.window.chartManager[method] === 'function') {
                                    log(`Method ${method} exists and is callable`, 'success');
                                    methodsWorking++;
                                    
                                    // Try calling the method (should not cause recursion)
                                    try {
                                        const result = appWindow.window.chartManager[method]('test-canvas-' + method.replace(/[A-Z]/g, '-$&').toLowerCase());
                                        log(`Method ${method} executed without recursion`, 'success');
                                    } catch (error) {
                                        log(`Method ${method} execution error: ${error.message}`, 'error');
                                    }
                                } else {
                                    log(`Method ${method} not found or not callable`, 'error');
                                }
                            });
                            
                            log(`\nðŸ“Š Summary: ${methodsWorking}/${testMethods.length} methods working`, methodsWorking === testMethods.length ? 'success' : 'warning');
                        } else {
                            log('Chart manager not found in loaded application', 'error');
                        }

                        // Test navigation (which previously triggered recursion)
                        const navLinks = appWindow.document.querySelectorAll('.nav-link');
                        if (navLinks.length > 0) {
                            log(`Found ${navLinks.length} navigation links`, 'success');
                            
                            // Simulate clicking a navigation link that uses charts
                            if (navLinks.length > 0) {
                                navLinks[0].click(); // Click dashboard link
                                log('Simulated navigation click (dashboard)', 'success');
                            }
                        }

                        document.body.removeChild(iframe);
                        
                        // Final assessment
                        setTimeout(() => {
                            console.warn = originalConsoleWarn;
                            
                            log('\nðŸ Recursion Fix Test Complete!', 'info');
                            if (infiniteRecursionDetected) {
                                log(`âŒ RECURSION STILL DETECTED! ${recursionWarnings} warnings found`, 'error');
                                log('The fix needs further refinement.', 'error');
                            } else {
                                log('âœ… NO RECURSION DETECTED! Fix appears successful.', 'success');
                                log('Application loaded and charts worked without infinite loops.', 'success');
                            }
                        }, 1000);
                        
                    } catch (error) {
                        document.body.removeChild(iframe);
                        console.warn = originalConsoleWarn;
                        log(`Test error: ${error.message}`, 'error');
                    }
                }, 3000); // Wait for app to fully load
                
            } catch (error) {
                console.warn = originalConsoleWarn;
                log(`Setup error: ${error.message}`, 'error');
            }
        }

        function testChartManagerDirect() {
            clearResults();
            log('ðŸ“ˆ Testing Chart Manager Direct Access...', 'info');
            
            try {
                // Load chart solution directly
                const script = document.createElement('script');
                script.src = './js/unified-chart-solution.js?v=1.0.3';
                script.onload = () => {
                    setTimeout(() => {
                        if (window.chartManager) {
                            log('Chart manager loaded successfully', 'success');
                            
                            const methods = ['createChart', 'createRevenueChart', 'createEntityChart', 'createProductionChart'];
                            methods.forEach(method => {
                                if (typeof window.chartManager[method] === 'function') {
                                    log(`âœ“ ${method} method available`, 'success');
                                } else {
                                    log(`âœ— ${method} method missing`, 'error');
                                }
                            });
                        } else {
                            log('Chart manager not available', 'error');
                        }
                    }, 500);
                };
                document.head.appendChild(script);
                
            } catch (error) {
                log(`Direct test error: ${error.message}`, 'error');
            }
        }

        function runMainApplicationTest() {
            clearResults();
            log('ðŸ—ï¸ Testing Full Main Application...', 'info');
            
            // Open the main application in a new window for full testing
            try {
                log('Opening main application in new window...', 'info');
                const testWindow = window.open('./royalties.html', '_blank', 'width=1200,height=800');
                
                if (testWindow) {
                    log('âœ… Main application window opened successfully', 'success');
                    log('Check the new window for any console errors or recursion warnings.', 'info');
                    log('The application should load normally without freezing.', 'info');
                    
                    setTimeout(() => {
                        try {
                            if (!testWindow.closed) {
                                log('âœ… Application window still responsive after 5 seconds', 'success');
                                log('If no recursion errors appear in console, the fix is working!', 'success');
                            }
                        } catch (error) {
                            log('Note: Cannot access opened window due to browser security policies', 'info');
                        }
                    }, 5000);
                } else {
                    log('âŒ Failed to open application window (popup blocked?)', 'error');
                }
            } catch (error) {
                log(`Application test error: ${error.message}`, 'error');
            }
        }

        // Auto-run recursion test on page load
        window.addEventListener('load', () => {
            setTimeout(() => {
                log('ðŸš€ Auto-running recursion fix test...', 'info');
                testRecursionFix();
            }, 1000);
        });
    </script>
</body>
</html>
