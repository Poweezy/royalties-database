<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Royalty Records Test - Eswacaa Royalties Database</title>
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/layout.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/forms.css">
    <link rel="stylesheet" href="css/tables.css">
    <link rel="stylesheet" href="css/buttons.css">
    <link rel="stylesheet" href="css/badges.css">
    <link rel="stylesheet" href="css/utilities.css">
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="royalties.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .test-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 2rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-header {
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--primary-color);
        }
        .test-status {
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 6px;
            font-weight: 500;
        }
        .test-success {
            background: rgba(16, 185, 129, 0.1);
            color: #059669;
            border-left: 4px solid #10b981;
        }
        .test-error {
            background: rgba(239, 68, 68, 0.1);
            color: #dc2626;
            border-left: 4px solid #ef4444;
        }
        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <a href="royalties.html" class="btn btn-secondary back-btn">
        <i class="fas fa-arrow-left"></i> Back to Main App
    </a>

    <div class="test-container">
        <div class="test-header">
            <h1><i class="fas fa-money-bill-wave"></i> Royalty Records Management Test</h1>
            <p>Testing the complete functionality of the Royalty Records section</p>
            <div id="test-status" class="test-status test-success">
                <i class="fas fa-check-circle"></i> Test environment initialized successfully
            </div>
        </div>

        <!-- Test Results Summary -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-clipboard-check"></i> Test Results Summary</h5>
            </div>
            <div class="card-body">
                <div id="test-results">
                    <div class="test-item">
                        <span class="test-name">Data Population:</span>
                        <span class="test-result" id="data-test">Pending...</span>
                    </div>
                    <div class="test-item">
                        <span class="test-name">Event Handlers:</span>
                        <span class="test-result" id="events-test">Pending...</span>
                    </div>
                    <div class="test-item">
                        <span class="test-name">KPI Updates:</span>
                        <span class="test-result" id="kpi-test">Pending...</span>
                    </div>
                    <div class="test-item">
                        <span class="test-name">Table Population:</span>
                        <span class="test-result" id="table-test">Pending...</span>
                    </div>
                    <div class="test-item">
                        <span class="test-name">Filter Functionality:</span>
                        <span class="test-result" id="filter-test">Pending...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Component being tested -->
        <div id="royalty-records-section"></div>

        <!-- Test Controls -->
        <div class="card mt-4">
            <div class="card-header">
                <h5><i class="fas fa-tools"></i> Test Controls</h5>
            </div>
            <div class="card-body">
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="runAllTests()">
                        <i class="fas fa-play"></i> Run All Tests
                    </button>
                    <button class="btn btn-info" onclick="testDataPopulation()">
                        <i class="fas fa-database"></i> Test Data Loading
                    </button>
                    <button class="btn btn-warning" onclick="testEventHandlers()">
                        <i class="fas fa-mouse-pointer"></i> Test Event Handlers
                    </button>
                    <button class="btn btn-success" onclick="testFiltering()">
                        <i class="fas fa-filter"></i> Test Filtering
                    </button>
                </div>
            </div>
        </div>

        <!-- Test Logs -->
        <div class="card mt-4">
            <div class="card-header">
                <h5><i class="fas fa-list-alt"></i> Test Logs</h5>
            </div>
            <div class="card-body">
                <div id="test-logs" style="background: #f8f9fa; padding: 1rem; border-radius: 4px; font-family: monospace; white-space: pre-wrap; max-height: 300px; overflow-y: auto;">
Ready to run tests...
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/enhanced-notification-system.js"></script>
    <script src="js/unified-component-loader.js"></script>
    <script src="js/app.js"></script>

    <script>
        let testApp;
        let testLogs = [];

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            testLogs.push(logMessage);
            document.getElementById('test-logs').textContent = testLogs.join('\n');
            console.log(logMessage);
        }

        function updateTestResult(testId, status, message) {
            const element = document.getElementById(testId);
            if (element) {
                element.innerHTML = status === 'pass' 
                    ? `<i class="fas fa-check text-success"></i> Passed` 
                    : `<i class="fas fa-times text-danger"></i> Failed: ${message}`;
            }
        }

        async function initializeTest() {
            try {
                log('Initializing test environment...');
                
                // Debug: Check what's available in global scope
                log(`Available globals: RoyaltiesApp=${typeof window.RoyaltiesApp}, NotificationSystem=${typeof window.NotificationSystem}, unifiedComponentLoader=${typeof window.unifiedComponentLoader}`);
                
                // Initialize notification system first
                if (window.NotificationSystem) {
                    window.notificationManager = new window.NotificationSystem();
                    log('Notification system initialized');
                } else {
                    log('Warning: NotificationSystem not available');
                }

                // Wait a moment for scripts to load
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Check again after delay
                log(`After delay - RoyaltiesApp=${typeof window.RoyaltiesApp}`);

                // Create app instance and wait for it to initialize
                if (window.RoyaltiesApp) {
                    testApp = new window.RoyaltiesApp();
                    window.royaltiesApp = testApp;
                    
                    // Initialize the app and wait for completion
                    await testApp.initialize();
                    log('RoyaltiesApp initialized');
                    
                    // Verify dataManager is available
                    if (testApp.dataManager) {
                        log('DataManager confirmed available');
                        log(`DataManager methods: ${Object.getOwnPropertyNames(testApp.dataManager).filter(name => typeof testApp.dataManager[name] === 'function')}`);
                    } else {
                        log('Warning: DataManager not available after initialization');
                    }
                } else {
                    log('Error: RoyaltiesApp class not found');
                    return false;
                }

                // Load the royalty records component
                const container = document.getElementById('royalty-records-section');
                if (container && window.unifiedComponentLoader) {
                    const result = await window.unifiedComponentLoader.loadComponent('royalty-records', container);
                    if (result.success) {
                        log('Royalty Records component loaded successfully');
                        
                        // Wait a moment for DOM to update
                        await new Promise(resolve => setTimeout(resolve, 300));
                        
                        // Initialize the section
                        if (testApp.initializeRoyaltyRecords) {
                            testApp.initializeRoyaltyRecords();
                            log('Royalty Records section initialized');
                        } else {
                            log('Warning: initializeRoyaltyRecords method not found');
                        }
                    } else {
                        log(`Failed to load component: ${result.error}`);
                    }
                } else {
                    if (!container) log('Error: royalty-records-section container not found');
                    if (!window.unifiedComponentLoader) log('Warning: unifiedComponentLoader not available');
                }

                log('Test environment ready');
                return true;
            } catch (error) {
                log(`Error initializing test: ${error.message}`);
                log(`Stack trace: ${error.stack}`);
                return false;
            }
        }

        async function testDataPopulation() {
            log('Testing data population...');
            try {
                if (!testApp) {
                    log('Test app not initialized');
                    updateTestResult('data-test', 'fail', 'App not initialized');
                    return false;
                }

                if (!testApp.dataManager) {
                    log('DataManager not available');
                    updateTestResult('data-test', 'fail', 'DataManager not initialized');
                    return false;
                }

                const records = testApp.dataManager.getRoyaltyRecords();
                if (records && records.length > 0) {
                    log(`Found ${records.length} royalty records`);
                    updateTestResult('data-test', 'pass');
                    
                    // Test KPI population
                    testApp.updateRoyaltyRecordsKPIs(records);
                    log('KPI cards updated');
                    updateTestResult('kpi-test', 'pass');
                    
                    // Test table population
                    testApp.updateRoyaltyRecordsTable(records);
                    log('Records table populated');
                    updateTestResult('table-test', 'pass');
                    
                    return true;
                } else {
                    log('No royalty records found');
                    updateTestResult('data-test', 'fail', 'No data found');
                    return false;
                }
            } catch (error) {
                log(`Data population test failed: ${error.message}`);
                updateTestResult('data-test', 'fail', error.message);
                return false;
            }
        }

        async function testEventHandlers() {
            log('Testing event handlers...');
            try {
                // Test refresh button
                const refreshBtn = document.getElementById('refresh-records-btn');
                if (refreshBtn) {
                    refreshBtn.click();
                    log('Refresh button clicked');
                }

                // Test filter buttons
                const filterBtns = document.querySelectorAll('.filter-btn');
                if (filterBtns.length > 0) {
                    log(`Found ${filterBtns.length} filter buttons`);
                    // Test filtering to 'paid' status
                    const paidBtn = document.querySelector('[data-filter="paid"]');
                    if (paidBtn) {
                        paidBtn.click();
                        log('Paid filter applied');
                    }
                }

                updateTestResult('events-test', 'pass');
                return true;
            } catch (error) {
                log(`Event handlers test failed: ${error.message}`);
                updateTestResult('events-test', 'fail', error.message);
                return false;
            }
        }

        async function testFiltering() {
            log('Testing filtering functionality...');
            try {
                // Test status filtering
                testApp.filterRecords('paid');
                log('Paid records filtered');
                
                testApp.filterRecords('pending');
                log('Pending records filtered');
                
                testApp.filterRecords('overdue');
                log('Overdue records filtered');
                
                testApp.filterRecords('all');
                log('All records displayed');

                // Test search functionality
                testApp.searchRecords('Kwalini');
                log('Search for "Kwalini" executed');
                
                testApp.searchRecords('');
                log('Search cleared');

                updateTestResult('filter-test', 'pass');
                return true;
            } catch (error) {
                log(`Filtering test failed: ${error.message}`);
                updateTestResult('filter-test', 'fail', error.message);
                return false;
            }
        }

        async function runAllTests() {
            log('Running all tests...');
            
            const dataTest = await testDataPopulation();
            const eventTest = await testEventHandlers();
            const filterTest = await testFiltering();
            
            const allPassed = dataTest && eventTest && filterTest;
            
            log(`All tests completed. Result: ${allPassed ? 'PASSED' : 'FAILED'}`);
            
            const statusDiv = document.getElementById('test-status');
            if (allPassed) {
                statusDiv.className = 'test-status test-success';
                statusDiv.innerHTML = '<i class="fas fa-check-circle"></i> All tests passed successfully!';
            } else {
                statusDiv.className = 'test-status test-error';
                statusDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Some tests failed. Check logs for details.';
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', async () => {
            log('DOM loaded, starting initialization...');
            
            try {
                const initialized = await initializeTest();
                
                if (initialized) {
                    log('Initialization successful, running tests in 2 seconds...');
                    // Auto-run tests after initialization with longer delay
                    setTimeout(async () => {
                        try {
                            await runAllTests();
                        } catch (error) {
                            log(`Error running tests: ${error.message}`);
                        }
                    }, 2000);
                } else {
                    log('Initialization failed, skipping tests');
                    document.getElementById('test-status').innerHTML = 
                        '<i class="fas fa-exclamation-triangle"></i> Initialization failed';
                    document.getElementById('test-status').className = 'test-status test-error';
                }
            } catch (error) {
                log(`Initialization error: ${error.message}`);
                document.getElementById('test-status').innerHTML = 
                    '<i class="fas fa-exclamation-triangle"></i> Initialization error';
                document.getElementById('test-status').className = 'test-status test-error';
            }
        });
    </script>

    <style>
        .test-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #e5e7eb;
        }
        .test-item:last-child {
            border-bottom: none;
        }
        .test-name {
            font-weight: 600;
        }
        .text-success { color: #10b981; }
        .text-danger { color: #ef4444; }
    </style>
</body>
</html>
